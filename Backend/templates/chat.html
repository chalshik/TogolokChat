<!DOCTYPE html>
<html lang="en" 
    {% if session and session.user_id %}
    data-user-id="{{ session.user_id }}"
    data-authenticated="true"
    {% else %}
    data-authenticated="false"
    {% endif %}
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TogolohChat</title>
    <!-- Include Socket.IO client library -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #111b21;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        
        .sidebar {
            width: 30%;
            height: 100%;
            border-right: 1px solid #222d34;
            background-color: #111b21;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            height: 60px;
            background-color: #202c33;
        }
        
        .app-name {
            color: #e9edef;
            font-size: 16px;
            font-weight: bold;
        }
        
        .sidebar-header-icons {
            display: flex;
            gap: 15px;
        }
        
        .search-container {
            padding: 8px;
            background-color: #111b21;
        }
        
        .search-bar {
            background-color: #202c33;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
        }
        
        .search-bar input {
            background: transparent;
            border: none;
            color: #d1d7db;
            width: 100%;
            outline: none;
            margin-left: 10px;
            font-size: 15px;
        }
        
        .contact-list {
            overflow-y: auto;
            flex: 1;
        }
        
        /* Contact styles that were accidentally removed */
        .contact {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #222d34;
            cursor: pointer;
        }
        
        .contact:hover {
            background-color: #202c33;
        }
        
        .contact-active {
            background-color: #2a3942;
        }
        
        .profile-pic {
            width: 49px;
            height: 49px;
            border-radius: 50%;
            margin-right: 15px;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-name {
            color: #e9edef;
            font-size: 17px;
            margin-bottom: 3px;
        }
        
        .contact-message {
            color: #8696a0;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 45px;
        }
        
        .message-time {
            color: #8696a0;
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        /* Sidebar Navigation */
        .sidebar-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #1f2c33;
            height: 60px;
            width: 100%;
            border-top: 1px solid #222d34;
            margin-top: auto; /* Push to bottom of sidebar */
        }
        
        .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #8696a0;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        
        .nav-icon:hover {
            background-color: #2a3942;
        }
        
        .nav-icon.active {
            color: #00a884;
        }
        
        .nav-icon svg {
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
        }
        
        .nav-icon-label {
            font-size: 12px;
        }
        
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #0b141a;
            position: relative;
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background-color: #202c33;
            height: 60px;
        }
        
        .chat-header-info {
            flex: 1;
            margin-left: 15px;
        }
        
        .chat-header-name {
            color: #e9edef;
            font-size: 16px;
        }
        
        .chat-header-status {
            font-size: 13px;
            color: #8696a0;
            margin-top: 2px;
        }
        
        .chat-header-status.online {
            color: #00a884;
        }
        
        .chat-header-status.offline {
            color: #8696a0;
        }
        
        .chat-header-icons {
            display: flex;
            gap: 20px;
            color: #aebac1;
        }
        
        .chat-body {
            flex: 1;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: contain;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 65%;
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
        }
        
        .received {
            background-color: #202c33;
            color: #e9edef;
            align-self: flex-start;
            border-top-left-radius: 0;
        }
        
        .sent {
            background-color: #005c4b;
            color: #e9edef;
            align-self: flex-end;
            border-top-right-radius: 0;
        }
        
        .message-content {
            font-size: 14px;
            margin-right: 80px;
        }
        
        .message-timestamp {
            position: absolute;
            bottom: 5px;
            right: 7px;
            color: #8696a0;
            font-size: 11px;
        }
        
        .chat-footer {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #202c33;
        }
        
        .chat-footer-icons {
            display: flex;
            gap: 15px;
            color: #8696a0;
            padding: 0 15px;
        }
        
        .message-input {
            flex: 1;
            background-color: #2a3942;
            border-radius: 8px;
            border: none;
            padding: 9px 12px;
            color: #d1d7db;
            outline: none;
            font-size: 15px;
        }
        
        .send-button {
            margin-left: 10px;
            color: #8696a0;
            cursor: pointer;
        }
        
        .icon {
            cursor: pointer;
        }
        
        /* Content Areas */
        .content-area {
            display: none;
            flex: 1;
            flex-direction: column;
        }
        
        .content-area.active {
            display: flex;
        }
        
        .contacts-area {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Contacts screen */
        .contacts-header {
            padding: 16px;
            background-color: #1f2c33;
            color: #e9edef;
            font-size: 20px;
            font-weight: bold;
        }
        
        /* Utility Classes */
        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                display: none;
            }
            
            .main-chat {
                width: 100%;
            }
        }
        
        /* Settings Sidebar Styles */
        .settings-sidebar {
            width: 30%;
            height: calc(100% - 60px); /* Subtract navigation height */
            background-color: #111b21;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; /* Add padding for navigation */
        }

        /* Profile Section Styles */
        .profile-section {
            background-color: #202c33;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar-container {
            position: relative;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            padding: 5px;
            cursor: pointer;
        }

        .profile-info {
            flex: 1;
        }

        .profile-nickname {
            color: #e9edef;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-name input {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #374045;
            color: #e9edef;
            font-size: 16px;
            padding: 5px 0;
            width: 100%;
            outline: none;
        }

        .profile-bio textarea {
            background-color: transparent;
            border: 1px solid #374045;
            border-radius: 5px;
            color: #e9edef;
            width: 100%;
            padding: 10px;
            resize: none;
            height: 100px;
            outline: none;
        }

        .profile-bio textarea:focus,
        .profile-name input:focus {
            border-color: #00a884;
        }

        /* Settings Section Styles */
        .settings-section {
            background-color: #202c33;
            border-radius: 10px;
            padding: 20px;
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            color: #e9edef;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .settings-item:hover {
            background-color: #374045;
        }

        .settings-item i,
        .settings-item svg {
            width: 24px;
            height: 24px;
            color: #8696a0;
        }

        .settings-item span {
            font-size: 16px;
        }

        #logout-button {
            color: #f15e6c;
        }

        #logout-button i {
            color: #f15e6c;
        }

        /* Added for user selection */
        .user-item.user-selected {
            background-color: #2a3942 !important; /* Force selection background */
        }

        .add-contact-footer {
            padding: 10px 15px;
            background-color: #111b21;
            border-top: 1px solid #222d34;
            margin-top: auto; /* Push to bottom */
        }

        .add-contact-footer button {
            width: 100%;
            padding: 12px;
            background-color: #00a884;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .add-contact-footer button:disabled {
            background-color: #2a3942;
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ... existing styles ... */

        .contacts-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: #111b21;
        }

        .contact-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #222d34;
            transition: background-color 0.2s;
        }

        .contact-item:hover {
            background-color: #202c33;
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 15px;
            overflow: hidden;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            color: #e9edef;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .contact-status {
            color: #8696a0;
            font-size: 13px;
        }

        .loading-contacts {
            text-align: center;
            padding: 20px;
            color: #8696a0;
        }

        .no-contacts {
            text-align: center;
            padding: 20px;
            color: #8696a0;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar will be handled by you -->
        <div class="sidebar">
            <div class="sidebar-content">
            <div class="sidebar-header">
                <div class="app-name">TogolohChat</div>
                <div class="sidebar-header-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M12 20.664a8.664 8.664 0 0 1-8.664-8.664A8.664 8.664 0 0 1 12 3.336a8.664 8.664 0 0 1 8.664 8.664A8.664 8.664 0 0 1 12 20.664zm0-17.328a8.664 8.664 0 0 0-8.664 8.664A8.664 8.664 0 0 0 12 20.664a8.664 8.664 0 0 0 8.664-8.664A8.664 8.664 0 0 0 12 3.336z"></path>
                        <path fill="currentColor" d="M12 14.504c-1.104 0-2-.896-2-2s.896-2 2-2 2 .896 2 2-.896 2-2 2zm0-5c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-bar">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                    </svg>
                    <input type="text" id="search-input" placeholder="Іздеу же жаңы чат баштоо..." onkeyup="searchContacts()">
                </div>
            </div>
            
            <div class="contact-list" id="contact-list">
                <!-- Contacts will be loaded dynamically -->
                <div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">
                    Loading contacts...
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Navigation (moved from bottom) -->
            <div class="sidebar-nav">
                <div class="nav-icon active" data-target="contacts">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"></path>
                    </svg>
                    <span class="nav-icon-label">Contacts</span>
                </div>
                <div class="nav-icon" data-target="groups">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"></path>
                    </svg>
                    <span class="nav-icon-label">Groups</span>
                </div>
                <div class="nav-icon" data-target="add">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                    <span class="nav-icon-label">Add</span>
                </div>
                <div class="nav-icon" data-target="settings">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                    </svg>
                    <span class="nav-icon-label">Settings</span>
                </div>
            </div>
        </div>
        
        <!-- Settings Sidebar -->
        <div class="settings-sidebar" style="display: none;">
            <div class="sidebar-header">
                <div class="sidebar-header-back">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19.8 11H7.5l5.6-5.6L11.7 4l-8 8 8 8 1.4-1.4L7.5 13h12.3v-2z"></path>
                    </svg>
                </div>
                <div class="app-name">Profile & Settings</div>
                <div class="close-settings">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="settings-content">
                <!-- Profile Section -->
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar-container">
                            <div class="profile-avatar">
                                <img id="profile-avatar-img" src="/api/placeholder/100/100" alt="Profile">
                                <div class="avatar-edit">
                                    <i class="fa-solid fa-camera"></i>
                                </div>
                            </div>
                        </div>
                        <div class="profile-info">
                            <div class="profile-nickname" id="profile-nickname">Loading...</div>
                            <div class="profile-name">
                                <input type="text" id="profile-name-input" placeholder="Your Name">
                            </div>
                        </div>
                    </div>
                    <div class="profile-bio">
                        <textarea id="profile-bio-input" placeholder="Write something about yourself..."></textarea>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="settings-section">
                    <div class="settings-list">
                        <div class="settings-item" id="language-settings">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M12 22.0005C5.07 22.0005 1.5 18.5205 1.5 12.0005C1.5 5.48047 5.07 2.00047 12 2.00047C18.93 2.00047 22.5 5.48047 22.5 12.0005C22.5 18.5205 18.93 22.0005 12 22.0005ZM12 3.50047C5.82 3.50047 3 6.24047 3 12.0005C3 17.7605 5.82 20.5005 12 20.5005C18.18 20.5005 21 17.7605 21 12.0005C21 6.24047 18.18 3.50047 12 3.50047ZM15.53 13.8805C15.82 13.2405 16 12.9505 16 12.0005C16 11.0505 15.82 10.7605 15.53 10.1205C15.37 9.78047 15.1 9.50047 14.79 9.27047C14.43 9.00047 14.25 8.77047 14.25 7.75047V7.50047C14.25 6.94047 13.81 6.50047 13.25 6.50047H10.75C10.19 6.50047 9.75 6.94047 9.75 7.50047V7.72047C9.75 8.69047 9.59 8.87047 9.33 9.11047C9 9.42047 8.71 9.75047 8.5 10.1705C8.19 10.8005 8 11.1505 8 12.0005C8 12.8505 8.19 13.1905 8.48 13.7905C8.71 14.1905 9 14.5305 9.34 14.8505C9.58 15.0605 9.75 15.2805 9.75 16.2405V16.5005C9.75 17.0605 10.19 17.5005 10.75 17.5005H13.25C13.81 17.5005 14.25 17.0605 14.25 16.5005V16.2405C14.25 15.2805 14.41 15.0605 14.67 14.8305C15 14.5305 15.3 14.2005 15.53 13.8805ZM12 14.0005C10.9 14.0005 10 13.1005 10 12.0005C10 10.9005 10.9 10.0005 12 10.0005C13.1 10.0005 14 10.9005 14 12.0005C14 13.1005 13.1 14.0005 12 14.0005Z"></path>
                            </svg>
                            <span>Change Language</span>
                        </div>
                        <div class="settings-item" id="password-settings">
                            <i class="fa-solid fa-key"></i>
                            <span>Change Password</span>
                        </div>
                        <div class="settings-item" id="admin-panel">
                            <i class="fa-solid fa-user-shield"></i>
                            <span>Admin Panel</span>
                        </div>
                        <div class="settings-item" id="logout-button">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-chat">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="profile-pic">
                    <img src="/api/placeholder/49/49" alt="Profile">
                </div>
                <div class="chat-header-info">
                    <!-- there should be name and status of the user -->
                </div>
                <div class="chat-header-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M15.9 14.3H15l-.3-.3c1-1.1 1.6-2.7 1.6-4.3 0-3.7-3-6.7-6.7-6.7S3 6 3 9.7s3 6.7 6.7 6.7c1.6 0 3.2-.6 4.3-1.6l.3.3v.8l5.1 5.1 1.5-1.5-5-5.2zm-6.2 0c-2.6 0-4.6-2.1-4.6-4.6s2.1-4.6 4.6-4.6 4.6 2.1 4.6 4.6-2 4.6-4.6 4.6z"></path>
                    </svg>
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"></path>
                    </svg>
                </div>
            </div>
            
            <!-- Chat Body -->
            <div class="chat-body">
                <!-- there should be messages between users   -->
                 
            </div>
            
            <!-- Chat Footer -->
            <div class="chat-footer">
                <div class="chat-footer-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M9.153 11.603c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962zm-3.204 1.362c-.026-.307-.131 5.218 6.063 5.551 6.066-.25 6.066-5.551 6.066-5.551-6.078 1.416-12.129 0-12.129 0zm11.363 1.108s-.669 1.959-5.051 1.959c-3.505 0-5.388-1.164-5.607-1.959 0 0 5.912 1.055 10.658 0zM11.804 1.011C5.609 1.011.978 6.033.978 12.228s4.826 10.761 11.021 10.761S23.02 18.423 23.02 12.228c.001-6.195-5.021-11.217-11.216-11.217zM12 21.354c-5.273 0-9.381-3.886-9.381-9.159s3.942-9.548 9.215-9.548 9.548 4.275 9.548 9.548c-.001 5.272-4.109 9.159-9.382 9.159zm3.108-9.751c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962z"></path>
                    </svg>
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M1.816 15.556v.002c0 1.502.584 2.912 1.646 3.972s2.472 1.647 3.974 1.647a5.58 5.58 0 0 0 3.972-1.645l9.547-9.548c.769-.768 1.147-1.767 1.058-2.817-.079-.968-.548-1.927-1.319-2.698-1.594-1.592-4.068-1.711-5.517-.262l-7.916 7.915c-.881.881-.792 2.25.214 3.261.959.958 2.423 1.053 3.263.215l5.511-5.512c.28-.28.267-.722.053-.936l-.244-.244c-.191-.191-.567-.349-.957.04l-5.506 5.506c-.18.18-.635.127-.976-.214-.098-.097-.576-.613-.213-.973l7.915-7.917c.818-.817 2.267-.699 3.23.262.5.501.802 1.1.849 1.685.051.573-.156 1.111-.589 1.543l-9.547 9.549a3.97 3.97 0 0 1-2.829 1.171 3.975 3.975 0 0 1-2.83-1.173 3.973 3.973 0 0 1-1.172-2.828c0-1.071.415-2.076 1.172-2.83l7.209-7.211c.157-.157.264-.579.028-.814L11.5 4.36a.572.572 0 0 0-.834.018l-7.205 7.207a5.577 5.577 0 0 0-1.645 3.971z"></path>
                    </svg>
                </div>
                
                <input type="text" class="message-input" placeholder="Қабарыңызды жазыңыз">
                
                <div class="send-button">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection with reconnection options
        const socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: 5
        });
        
        // Initialize current chat variable
        window.currentChat = null;
        
        // Clean up existing socket listeners
        function cleanupSocketListeners() {
            socket.off('new_message');
            socket.off('message_sent');
            socket.off('notification');
            socket.off('user_status');
        }
        
        // Setup socket event listeners
        function setupSocketListeners() {
            // Clean up existing listeners first
            cleanupSocketListeners();
        
        // Handle notifications
        socket.on('notification', function(data) {
            console.log('Received notification:', data);
            
            if (data.type === 'contact_added') {
                showNotification(data.message, 'success');
                loadContacts();
            }
            else if (data.type === 'added_to_group') {
                showNotification(data.message, 'success');
                loadContacts();
                
                if (document.querySelector('.nav-icon[data-target="groups"]').classList.contains('active')) {
                    loadGroups();
                }
            }
        });
        
            // Handle new message event
        socket.on('new_message', function(data) {
                console.log('Received new_message:', data);
            
            const currentChatId = window.currentChat?.id;
            const currentChatType = window.currentChat?.type;
            const isFromCurrentUser = data.sender_id == document.documentElement.getAttribute('data-user-id');
            const timestamp = data.timestamp || Date.now();
            
            // Update contact list for the sender
            if (!isFromCurrentUser) {
                updateContactLastMessage(data.sender_id, data.message, timestamp);
            }
            
            // Handle message display in chat
            if (data.group_id) {
                if (currentChatType === 'group' && currentChatId == data.group_id) {
                    const chatBody = document.querySelector('.chat-body');
                    const messageElement = document.createElement('div');
                        messageElement.className = 'message received';
                        
                        const senderName = `<div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${data.sender_username}</div>`;
                    
                    messageElement.innerHTML = `
                        ${senderName}
                        <div class="message-content">${data.message}</div>
                        <span class="message-timestamp">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                } else {
                    showNotification(`New message in group: ${data.message}`);
                }
                } 
                // Handle direct messages
                else {
                    if (currentChatType === 'direct' && (currentChatId == data.sender_id || currentChatId == data.receiver_id)) {
                    const chatBody = document.querySelector('.chat-body');
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message received';
                    messageElement.innerHTML = `
                        <div class="message-content">${data.message}</div>
                        <span class="message-timestamp">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                        // Send read receipt
                    socket.emit('update_message_status', {
                        message_id: data.message_id,
                        status: 'read',
                        chat_id: data.sender_id,
                        chat_type: 'direct'
                    });
                } else {
                    showNotification(`${data.sender_username}: ${data.message}`);
                }
            }
            });

            // Handle message sent confirmation
            socket.on('message_sent', function(data) {
                console.log('Message sent confirmation:', data);
                const timestamp = data.timestamp || Date.now();
                
                // Update contact list for the receiver
                updateContactLastMessage(data.receiver_id, data.message, timestamp);
                
                // Store the last active chat
                storeLastActiveChat(data.receiver_id, 'direct', data.receiver_username);
            });

            // Add user_status event listener
            socket.on('user_status', function(data) {
                console.log('User status update:', data);
                if (data.status === 'online') {
                    window.onlineUsers.add(data.user_id);
                } else {
                    window.onlineUsers.delete(data.user_id);
                }
                updateUserStatus(data.user_id, data.status === 'online');
            });
        }
        
        // Socket connection events
        socket.on('connect', function() {
            console.log('Connected to server');
            
            const htmlElement = document.documentElement;
            const isAuthenticated = htmlElement.getAttribute('data-authenticated') === 'true';
            
            if (isAuthenticated) {
                const userId = htmlElement.getAttribute('data-user-id');
                socket.emit('join', { room: userId });
                console.log('Joined personal room:', userId);
                
                // Request current online users
                socket.emit('request_online_users');
                
                // Setup socket listeners and load contacts
                setupSocketListeners();
                loadContacts();
            } else {
                console.log('Not authenticated, no room to join');
            }
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            cleanupSocketListeners();
        });
        
        // Function to load contacts and groups from the backend
        function loadContacts() {
            const sidebarContent = document.querySelector('.sidebar-content');
            if (!sidebarContent) return;

            // Set up the contacts container structure
            sidebarContent.innerHTML = `
                <div class="contacts-container">
                    <div class="sidebar-header">
                        <div class="app-name">Contacts</div>
                    </div>
                    <div class="search-container">
                        <div class="search-bar">
                            <svg viewBox="0 0 24 24" width="24" height="24" class="search-icon">
                                <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                            </svg>
                            <input type="text" id="contact-search" placeholder="Search contacts" onkeyup="filterContacts()">
                        </div>
                    </div>
                    <div class="contact-list">
                        <div class="loading-contacts">Loading contacts...</div>
                    </div>
                </div>
            `;

            // Fetch contacts from server
            console.log('Fetching contacts from server...');
            fetch('/chat/contacts')
                .then(response => {
                    console.log('Contacts API response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    return response.json();
                })
                .then(contacts => {
                    console.log('Received contacts:', contacts);
                    const contactList = document.querySelector('.contact-list');
                    
                    if (!contacts || contacts.length === 0) {
                        contactList.innerHTML = `
                            <div class="no-contacts">
                                <p>No contacts yet</p>
                                <p>Click the "+" button below to add contacts</p>
                            </div>
                        `;
                        return;
                    }

                    // Store contacts globally for search functionality
                    window.userContacts = contacts;
                    console.log('Stored contacts in window.userContacts:', window.userContacts);

                    // Clear loading message
                    contactList.innerHTML = '';

                    // Process and sort contacts
                    const processedContacts = contacts.map(contact => {
                        const [id, username, lastMessage, lastMessageTime] = contact;
                        return {
                            id,
                            username,
                            last_message: lastMessage || '',
                            last_message_timestamp: lastMessageTime ? new Date(lastMessageTime).getTime() : 0,
                            last_message_time: lastMessageTime ? 
                                new Date(lastMessageTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''
                        };
                    });

                    // Sort contacts by last message timestamp
                    processedContacts.sort((a, b) => b.last_message_timestamp - a.last_message_timestamp);

                    // Create contact elements
                    processedContacts.forEach(contact => {
                        const contactElement = createContactElement([contact.id, contact.username], {
                            id: contact.id,
                            username: contact.username,
                            last_message: contact.last_message,
                            last_message_time: contact.last_message_time,
                            last_message_timestamp: contact.last_message_timestamp
                        });
                        contactList.appendChild(contactElement);
                    });

                    // Load last active chat
                    const lastChat = getLastActiveChat();
                    if (lastChat) {
                        const contact = processedContacts.find(c => c.id === lastChat.id);
                        if (contact) {
                            startChatWithContact(contact.id, contact.username);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    const contactList = document.querySelector('.contact-list');
                    contactList.innerHTML = `
                        <div class="no-contacts">
                            <p>Error loading contacts</p>
                            <p>Please try again later</p>
                        </div>
                    `;
                });
        }

        function createContactElement(contact, userDetail = null) {
            const contactId = contact[0];
            const contactElement = document.createElement('div');
            contactElement.className = 'contact';
            contactElement.setAttribute('data-contact-id', contactId);
            
            let displayName = userDetail?.username || contact[1] || 'Unknown User';
            let lastMessage = userDetail?.last_message || '';
            let lastMessageTime = userDetail?.last_message_time || '';
            
            // Use data URI for default avatar
            const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2U5ZWRlZiI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgM2MyLjY3IDAgNC44NCAyLjE3IDQuODQgNC44NFMxNC42NyAxNC42OCAxMiAxNC42OCA3LjE2IDEyLjUxIDcuMTYgOS44NCA5LjMzIDUgMTIgNXptMCAxM2MtMi4zMyAwLTQuMzEtLjgtNS45My0yLjQyLjg0LTEuNzEgMi41NS0yLjg4IDQuNTItMi44OCAxLjk3IDAgMy42OCAxLjE3IDQuNTIgMi44OEMxMy42OSAxNy4yIDExLjcgMTggOS4zNyAxOHoiLz48L3N2Zz4=';
            
            // Fix avatar path handling
            let profilePic;
            if (userDetail?.profile_picture) {
                profilePic = `/uploads/profile_photos/${userDetail.profile_picture}`;
            } else {
                profilePic = defaultAvatar;
            }

            contactElement.innerHTML = `
                <div class="profile-pic">
                    <img src="${profilePic}" alt="${displayName}" onerror="this.src='${defaultAvatar}'">
                </div>
                <div class="contact-info">
                    <div class="contact-name">${displayName}</div>
                    <div class="contact-message">${lastMessage}</div>
                </div>
                <div class="contact-meta">
                    <div class="message-time">${lastMessageTime}</div>
                </div>
            `;

            contactElement.onclick = () => startChatWithContact(contactId, displayName);
            return contactElement;
        }

        function filterContacts() {
            const searchInput = document.getElementById('contact-search');
            const filter = searchInput.value.toLowerCase();
            const contactItems = document.querySelectorAll('.contact-item');
            
            contactItems.forEach(item => {
                const name = item.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Modify the startChatWithContact function to include event listeners
        function startChatWithContact(contactId, displayName) {
            // Update current chat info
            window.currentChat = {
                id: contactId,
                type: 'direct',
                name: displayName
            };
            
            // Store the last active chat
            storeLastActiveChat(contactId, 'direct', displayName);
            
            // Update chat header
            const chatHeader = document.querySelector('.chat-header-info');
            if (chatHeader) {
                chatHeader.innerHTML = `
                    <div class="chat-header-name">${displayName}</div>
                    <div class="chat-header-status ${isUserOnline(contactId) ? 'online' : 'offline'}">${isUserOnline(contactId) ? 'online' : 'offline'}</div>
                `;
            }
            
            // Load chat messages
            loadChatMessages(contactId);
            
            // Show chat interface
            const chatInterface = document.querySelector('.chat-interface');
            if (chatInterface) {
                chatInterface.style.display = 'flex';
            }

            // Set up message input event listeners
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-message');

            if (messageInput) {
                // Remove existing listeners first to avoid duplicates
                messageInput.removeEventListener('keypress', handleEnterPress);
                // Add new listener
                messageInput.addEventListener('keypress', handleEnterPress);
            }

            if (sendButton) {
                // Remove existing listener first to avoid duplicates
                sendButton.removeEventListener('click', sendMessage);
                // Add new listener
                sendButton.addEventListener('click', sendMessage);
            }
        }

        // Helper function for Enter key press
        function handleEnterPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        // Function to handle contact click
        function handleContactClick() {
            // Remove active class from all contacts
            document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
            // Add active class to clicked contact
            this.classList.add('contact-active');
            
            // Get contact details
            const contactName = this.querySelector('.contact-name').textContent;
            const contactId = this.getAttribute('data-user-id');
            
            console.log(`Loading chat with ${contactName}, ID: ${contactId}`);
            
            // Set the current chat info for message sending
            window.currentChat = {
                id: contactId,
                type: 'direct',
                name: contactName
            };
            
            // Update the chat header with the selected contact's info
            document.querySelector('.chat-header-name').textContent = contactName;
            
            // Clear the current chat
            const chatBody = document.querySelector('.chat-body');
            chatBody.innerHTML = '';
            
            // Show loading indicator
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message';
            loadingElement.style.alignSelf = 'center';
            loadingElement.textContent = 'Loading messages...';
            chatBody.appendChild(loadingElement);
            
            // Fetch messages for this contact from the backend
            fetch(`/chat/get_messages/${contactId}`)
                .then(response => response.json())
                .then(messages => {
                    // Remove loading indicator
                    chatBody.innerHTML = '';
                    
                    // If no messages, show a welcome message
                    if (messages.length === 0) {
                        const welcomeElement = document.createElement('div');
                        welcomeElement.className = 'message';
                        welcomeElement.style.alignSelf = 'center';
                        welcomeElement.style.backgroundColor = '#202c33';
                        welcomeElement.style.padding = '10px 15px';
                        welcomeElement.style.borderRadius = '8px';
                        welcomeElement.style.color = '#e9edef';
                        welcomeElement.textContent = `Start chatting with ${contactName}`;
                        chatBody.appendChild(welcomeElement);
                    } else {
                        // Add messages to the chat
                        messages.forEach(msg => {
                            const [senderId, receiverId, msgContent, timestamp] = msg;
                            
                            // Check if this is a sent or received message
                            const isSent = senderId.toString() === document.documentElement.getAttribute('data-user-id');
                            
                            // Create message element
                            const messageElement = document.createElement('div');
                            messageElement.className = isSent ? 'message sent' : 'message received';
                            messageElement.innerHTML = `
                                <div class="message-content">${msgContent}</div>
                                <span class="message-timestamp">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            `;
                            
                            chatBody.appendChild(messageElement);
                        });
                    }
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    chatBody.innerHTML = '';
                    
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message';
                    errorElement.style.alignSelf = 'center';
                    errorElement.style.backgroundColor = '#8B0000';
                    errorElement.style.padding = '10px 15px';
                    errorElement.style.borderRadius = '8px';
                    errorElement.style.color = '#ffffff';
                    errorElement.textContent = 'Error loading messages. Please try again.';
                    chatBody.appendChild(errorElement);
                });
        }
        
        // Function to search contacts
        function searchContacts() {
            const searchInput = document.getElementById('search-input');
            const filter = searchInput.value.toLowerCase();
            const contacts = document.querySelectorAll('.contact');
            
            contacts.forEach(contact => {
                const name = contact.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    contact.style.display = '';
                } else {
                    contact.style.display = 'none';
                }
            });
            
            // Show no results message if all contacts are hidden
            const visibleContacts = Array.from(contacts).filter(c => c.style.display !== 'none');
            const contactList = document.getElementById('contact-list');
            const noResultsMsg = contactList.querySelector('.no-results');
            
            if (visibleContacts.length === 0 && filter) {
                if (!noResultsMsg) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.style.color = '#8696a0';
                    noResults.style.textAlign = 'center';
                    noResults.style.padding = '20px';
                    noResults.textContent = `No contacts found for "${filter}"`;
                    contactList.appendChild(noResults);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // Function to send a message
        function sendMessage() {
            const messageInput = document.querySelector('.message-input');
            if (!messageInput) {
                console.error('Message input not found');
                return;
            }

            const message = messageInput.value.trim();
            
            if (!message || !window.currentChat) {
                if (!window.currentChat) {
                    showNotification('Please select a contact or group first', 'error');
                }
                return;
            }

            // Generate a unique message ID
            const messageId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const timestamp = Date.now();
            const time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            // Add message to UI immediately
            const chatBody = document.querySelector('.chat-body');
            if (!chatBody) {
                console.error('Chat body not found');
                return;
            }

            const messageElement = document.createElement('div');
            messageElement.className = 'message sent';
            messageElement.innerHTML = `
                <div class="message-content">${message}</div>
                <span class="message-timestamp">${time}</span>
            `;
            chatBody.appendChild(messageElement);
            chatBody.scrollTop = chatBody.scrollHeight;

            // Clear input
            messageInput.value = '';

            // Update contact's last message in the database
            fetch('/chat/update_last_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contact_id: window.currentChat.id,
                    message: message,
                    timestamp: timestamp
                })
            });

            // Emit message through socket
            socket.emit('send_message', {
                receiver_id: window.currentChat.id,
                message: message,
                timestamp: timestamp,
                message_id: messageId
            });
        }

        // Attach event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Send message on Enter key
            const messageInput = document.querySelector('.message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // Prevent default to avoid newline
                        sendMessage();
                    }
                });
            }

            // Send message on button click
            const sendButton = document.querySelector('.send-button');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
        });
        
        // Bottom navigation functionality
        const navIcons = document.querySelectorAll('.nav-icon');
        navIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const target = this.getAttribute('data-target');
                const settingsSidebar = document.querySelector('.settings-sidebar');
                const mainSidebarContent = document.querySelector('.sidebar-content');

                // Remove active class from all nav icons
                navIcons.forEach(i => i.classList.remove('active'));
                // Add active class to clicked icon
                this.classList.add('active');
                
                // --- Start Fix: Hide settings sidebar if visible when switching views ---
                if (settingsSidebar && settingsSidebar.style.display !== 'none') {
                    settingsSidebar.style.display = 'none';
                }
                // --- End Fix ---

                // Ensure main content area is visible for contacts/groups
                if (mainSidebarContent && (target === 'contacts' || target === 'groups')) {
                    mainSidebarContent.style.display = 'flex'; // Or 'block' if that was the default
                }
                
                console.log(`Switching to ${target} view`);
                
                // Handle specific targets
                if (target === 'add') {
                    // Show main content for add contact view
                    if (mainSidebarContent) {
                        mainSidebarContent.style.display = 'flex';
                        mainSidebarContent.style.flexDirection = 'column';
                    }
                    showAddContactModal();
                } else if (target === 'contacts') {
                    showMainSidebar(); // Use showMainSidebar to rebuild the contacts view
                } else if (target === 'groups') {
                    showGroupsView();
                } else if (target === 'settings') {
                    // showSettingsSidebar handles hiding main content
                    showSettingsSidebar();
                }
            });
        });
        
        // Function to show settings sidebar
        function showSettingsSidebar() {
            const settingsSidebar = document.querySelector('.settings-sidebar');
            if (!settingsSidebar) {
                console.error('Settings sidebar element not found');
                return;
            }
            
            // Hide main sidebar content but keep navigation
            const sidebarContent = document.querySelector('.sidebar-content');
            if (sidebarContent) {
                sidebarContent.style.display = "none";
            }
            
            // Show settings sidebar
            settingsSidebar.style.display = "flex";
            
            // Make sure navigation stays visible
            const sidebarNav = document.querySelector('.sidebar-nav');
            if (sidebarNav) {
                sidebarNav.style.display = "flex";
                // Set settings icon as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="settings"]').classList.add('active');
            }
            
            // Add event listeners
            const backButton = settingsSidebar.querySelector('.sidebar-header-back');
            const closeButton = settingsSidebar.querySelector('.close-settings');
            const languageSettings = settingsSidebar.querySelector('#language-settings');
            const passwordSettings = settingsSidebar.querySelector('#password-settings');
            const adminPanel = settingsSidebar.querySelector('#admin-panel');
            
            if (backButton) {
                backButton.addEventListener("click", () => {
                    settingsSidebar.style.display = "none";
                    showMainSidebar();
                });
            }
            
            if (closeButton) {
                closeButton.addEventListener("click", () => {
                    settingsSidebar.style.display = "none";
                    showMainSidebar();
                });
            }
            
            if (languageSettings) {
                languageSettings.addEventListener("click", showLanguageSettings);
            }
            
            if (passwordSettings) {
                passwordSettings.addEventListener("click", showPasswordSettings);
            }
            
            if (adminPanel) {
                adminPanel.addEventListener("click", () => {
                    loadAdminPanel();
                });
            }
        }

        // Function to show language settings
        function showLanguageSettings() {
            // Create a simple notification since this feature is not fully implemented
            showNotification('Language settings feature is coming soon!', 'info');
        }

        // Function to show password change settings
        function showPasswordSettings() {
            // Create a simple notification since this feature is not fully implemented
            showNotification('Password change feature is coming soon!', 'info');
        }

        function showMainSidebar() {
            // Set contacts tab as active
            document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
            document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            
            // Show contacts view
            const sidebarContent = document.querySelector('.sidebar-content');
            sidebarContent.style.display = "none";
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div class="app-name">TogolohChat</div>
                    <div class="sidebar-header-icons">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M12 20.664a8.664 8.664 0 0 1-8.664-8.664A8.664 8.664 0 0 1 12 3.336a8.664 8.664 0 0 1 8.664 8.664A8.664 8.664 0 0 1 12 20.664zm0-17.328a8.664 8.664 0 0 0-8.664 8.664A8.664 8.664 0 0 0 12 20.664a8.664 8.664 0 0 0 8.664-8.664A8.664 8.664 0 0 0 12 3.336z"></path>
                            <path fill="currentColor" d="M12 14.504c-1.104 0-2-.896-2-2s.896-2 2-2 2 .896 2 2-.896 2-2 2zm0-5c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z"></path>
                        </svg>
                    </div>
                </div>
                
                <div class="search-container">
                    <div class="search-bar">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                        </svg>
                        <input type="text" id="search-input" placeholder="Іздеу же жаңы чат баштоо..." onkeyup="searchContacts()">
                    </div>
                </div>
                
                <div class="contact-list" id="contact-list">
                    <div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">
                        Loading contacts...
                    </div>
                </div>
            `;
            sidebarContent.style.display = "block";
            
            // Reattach event listeners and load contacts
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keyup', searchContacts);
            }
            
            // Refresh contacts
            loadContacts();
        }

        // Function to load and show admin panel
        function loadAdminPanel() {
            showAdminPasswordPrompt();
        }

        // Function to show admin password prompt
        function showAdminPasswordPrompt() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Admin Authentication</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="color: #e9edef;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Enter Admin Password</label>
                        <input type="password" id="admin-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                    </div>
                    <button id="verify-admin" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Verify
                    </button>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const verifyButton = panel.querySelector('#verify-admin');
            const passwordInput = panel.querySelector('#admin-password');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Add enter key support
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });

            verifyButton.addEventListener('click', verifyPassword);

            function verifyPassword() {
                const password = passwordInput.value;
                if (password === '1234') {
                    document.body.removeChild(modal);
                    showActualAdminPanel();
                } else {
                    showNotification('Incorrect admin password', 'error');
                }
            }
        }

        // Function to show actual admin panel with user list
        function showActualAdminPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.className = 'admin-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '800px';
            panel.style.maxWidth = '90%';
            panel.style.maxHeight = '80vh';
            panel.style.overflowY = 'auto';
            panel.style.borderRadius = '8px';
            panel.style.display = 'flex';
            panel.style.flexDirection = 'column';

            // Initial panel content with loading state
            panel.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #374045;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #e9edef; margin: 0;">Admin Panel</h2>
                        <div class="close-button" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                    <div style="position: relative;">
                        <input type="text" id="user-search" placeholder="Search users..." 
                            style="width: 100%; padding: 8px 32px 8px 8px; background-color: #2a3942; color: #e9edef; 
                            border: 1px solid #374045; border-radius: 4px; font-size: 14px;">
                        <svg viewBox="0 0 24 24" width="20" height="20" 
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #8696a0;">
                            <path fill="currentColor" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
                        </svg>
                    </div>
                </div>
                <div id="users-stats" style="padding: 15px; border-bottom: 1px solid #374045; color: #e9edef;">
                    Loading user statistics...
                </div>
                <div id="users-list" style="padding: 15px;">
                    <div style="color: #e9edef; text-align: center;">
                        Loading users...
                    </div>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const searchInput = panel.querySelector('#user-search');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Load and display users
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    const users = data.users;
                    const usersList = panel.querySelector('#users-list');
                    const usersStats = panel.querySelector('#users-stats');

                    // Update stats
                    usersStats.innerHTML = `
                        <div style="font-size: 16px;">
                            Total Users: <span style="color: #00a884; font-weight: bold;">${users.length}</span>
                        </div>
                    `;

                    // Function to render users
                    function renderUsers(filteredUsers) {
                        usersList.innerHTML = filteredUsers.map(user => `
                            <div class="user-item" style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; 
                                background-color: #2a3942; border-radius: 4px; cursor: pointer;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #00a884; 
                                    display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-weight: bold;">
                                        ${user.username.charAt(0).toUpperCase()}
                                    </span>
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: #e9edef; font-weight: bold;">${user.username}</div>
                                    <div style="color: #8696a0; font-size: 13px;">${user.email || 'No email'}</div>
                                </div>
                            </div>
                        `).join('');
                    }

                    // Initial render
                    renderUsers(users);

                    // Search functionality
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const filteredUsers = users.filter(user => 
                            user.username.toLowerCase().includes(searchTerm) || 
                            (user.email && user.email.toLowerCase().includes(searchTerm))
                        );
                        renderUsers(filteredUsers);
                    });
                })
                .catch(error => {
                    console.error('Error fetching users:', error);
                    showNotification('Error loading users', 'error');
                });
        }

        // Function to show language settings modal
        function showLanguageSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Language Settings</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="color: #e9edef;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Select Language</label>
                        <select id="language-select" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                            <option value="en">English</option>
                            <option value="ky">Кыргызча</option>
                            <option value="ru">Русский</option>
                        </select>
                    </div>
                    <button id="save-language" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Save Changes
                    </button>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const saveButton = panel.querySelector('#save-language');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            saveButton.addEventListener('click', () => {
                const selectedLanguage = panel.querySelector('#language-select').value;
                // Here you would typically make an API call to save the language preference
                showNotification('Language preference saved!', 'success');
                document.body.removeChild(modal);
            });
        }

        // Function to show password change modal
        function showPasswordSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Change Password</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="color: #e9edef;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Current Password</label>
                        <input type="password" id="current-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">New Password</label>
                        <input type="password" id="new-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Confirm New Password</label>
                        <input type="password" id="confirm-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                    </div>
                    <button id="save-password" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Change Password
                    </button>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const saveButton = panel.querySelector('#save-password');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            saveButton.addEventListener('click', () => {
                const currentPassword = panel.querySelector('#current-password').value;
                const newPassword = panel.querySelector('#new-password').value;
                const confirmPassword = panel.querySelector('#confirm-password').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    showNotification('Please fill in all fields', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showNotification('New passwords do not match', 'error');
                    return;
                }

                // Get current username from the page (you might need to add this attribute if it's not there)
                // For now, assuming it exists. If not, we need to fetch user info first.
                const username = document.documentElement.getAttribute('data-username') || document.documentElement.getAttribute('data-user-id'); // Fallback to ID if username isn't directly available
                if (!username) {
                     showNotification('Could not identify user. Please log in again.', 'error');
                     return;
                }

                // Make API call to change password
                fetch('/api/change_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username, // The API expects username, adjust if needed
                        old_password: currentPassword,
                        new_password: newPassword
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "Password changed successfully!") {
                        showNotification('Password changed successfully!', 'success');
                        document.body.removeChild(modal);
                    } else {
                        showNotification(data.message || 'Error changing password', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error changing password:', error);
                    showNotification('Error changing password', 'error');
                });
            });
        }

        // Add this after the existing socket connection code but before other functions

        // Function to load chat messages for a contact
        function loadChatMessages(contactId) {
            const chatBody = document.querySelector('.chat-body');
            if (!chatBody) return;
            
            chatBody.innerHTML = '<div class="loading-messages">Loading messages...</div>';
            
            // Load existing messages
            fetch(`/chat/get_messages/${contactId}`)
                .then(response => response.json())
                .then(messages => {
                    chatBody.innerHTML = ''; // Clear loading message
                    
                    // Display each message
                    messages.forEach(msg => {
                        const [senderId, receiverId, messageText, timestamp] = msg;
                        const isSent = senderId == document.documentElement.getAttribute('data-user-id');
                        
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                        messageElement.innerHTML = `
                            <div class="message-content">${messageText}</div>
                            <span class="message-timestamp">${formatTimestamp(timestamp)}</span>
                        `;
                        
                        chatBody.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    chatBody.innerHTML = '<div class="error-message">Failed to load messages</div>';
                });
        }

        // Function to format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Handle receiving messages
        socket.on('new_message', function(data) {
            // Only show message if we're in the correct chat
            if (window.currentChat && (
                (data.sender_id == window.currentChat.id) || 
                (data.receiver_id == window.currentChat.id)
            )) {
                const chatBody = document.querySelector('.chat-body');
                const messageElement = document.createElement('div');
                messageElement.className = `message ${data.sender_id == document.documentElement.getAttribute('data-user-id') ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-content">${data.message}</div>
                    <span class="message-timestamp">${formatTimestamp(new Date(data.timestamp))}</span>
                `;
                chatBody.appendChild(messageElement);
                chatBody.scrollTop = chatBody.scrollHeight;
                
                // Send read receipt
                socket.emit('update_message_status', {
                    message_id: data.message_id,
                    status: 'read',
                    chat_id: data.sender_id,
                    chat_type: 'direct'
                });
            } else {
                // Show notification for messages from other chats
                showNotification(`New message from ${data.sender_username}: ${data.message}`);
            }
        });

        // Add a map to track online users
        window.onlineUsers = new Set();
        
        // Function to update user status in chat header
        function updateUserStatus(userId, isOnline) {
            // Only update if we're in a direct chat with this user
            if (window.currentChat && 
                window.currentChat.type === 'direct' && 
                window.currentChat.id == userId) {
                
                const statusElement = document.querySelector('.chat-header-status');
                if (statusElement) {
                    statusElement.textContent = isOnline ? 'online' : 'offline';
                    statusElement.className = 'chat-header-status ' + (isOnline ? 'online' : 'offline');
                }
            }
        }

        
        

        // Function to check if a user is online
        function isUserOnline(userId) {
            return window.onlineUsers.has(userId);
        }

        // Modify the function that displays chat header to include status
        function updateChatHeader(contactId, contactName) {
            const chatHeader = document.querySelector('.chat-header-info');
            if (chatHeader) {
                const isOnline = isUserOnline(contactId);
                chatHeader.innerHTML = `
                    <div class="chat-header-name">${contactName}</div>
                    <div class="chat-header-status ${isOnline ? 'online' : 'offline'}">${isOnline ? 'online' : 'offline'}</div>
                `;
            }
        }

        // When connecting, request current online users
        socket.on('connect', function() {
            console.log('Connected to server');
            
            const htmlElement = document.documentElement;
            const isAuthenticated = htmlElement.getAttribute('data-authenticated') === 'true';
            
            if (isAuthenticated) {
                const userId = htmlElement.getAttribute('data-user-id');
                socket.emit('join', { room: userId });
                console.log('Joined personal room:', userId);
                
                // Request current online users
                socket.emit('request_online_users');
                
                // Setup socket listeners and load contacts
                setupSocketListeners();
                
            } else {
                console.log('Not authenticated, no room to join');
            }
        });

        // Function to store the last active chat
        function storeLastActiveChat(chatId, chatType, chatName) {
            localStorage.setItem('lastActiveChat', JSON.stringify({
                id: chatId,
                type: chatType,
                name: chatName,
                timestamp: new Date().getTime()
            }));
        }

        // Function to retrieve the last active chat
        function getLastActiveChat() {
            const lastChat = localStorage.getItem('lastActiveChat');
            if (lastChat) {
                return JSON.parse(lastChat);
            }
            return null;
        }

        // Function to load the last active chat
        function loadLastActiveChat() {
            const lastChat = getLastActiveChat();
            if (lastChat) {
                if (lastChat.type === 'direct') {
                    startChatWithContact(lastChat.id, lastChat.name);
                } else if (lastChat.type === 'group') {
                    loadGroupChat(lastChat.id);
                }
            }
        }

        // Initialize the chat system
        document.addEventListener('DOMContentLoaded', function() {
            // Load the last active chat
            loadLastActiveChat();
        });

        // ... existing code ...
        // Function to sort contacts by last message timestamp
        function sortContactsByTimestamp(contacts) {
            return contacts.sort((a, b) => {
                const timestampA = a.last_message_timestamp || 0;
                const timestampB = b.last_message_timestamp || 0;
                return timestampB - timestampA;
            });
        }

        // Function to render contacts with sorting
        function renderContacts(contacts) {
            const contactList = document.querySelector('.contact-list');
            if (!contactList) return;

            // Sort contacts by last message timestamp
            const sortedContacts = sortContactsByTimestamp(contacts);

            contactList.innerHTML = sortedContacts.map(contact => `
                <div class="contact" data-contact-id="${contact.id}" onclick="startChatWithContact(${contact.id}, '${contact.username}')">
                    <div class="profile-pic">
                        <img src="${contact.profile_pic || '/static/default_profile.png'}" alt="${contact.username}">
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.username}</div>
                        <div class="contact-message">${contact.last_message || ''}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="message-time">${contact.last_message_time || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // Function to update contact's last message timestamp
        function updateContactTimestamp(contactId, timestamp) {
            const contacts = window.contacts || [];
            const contactIndex = contacts.findIndex(c => c.id === contactId);
            
            if (contactIndex !== -1) {
                contacts[contactIndex].last_message_timestamp = timestamp;
                contacts[contactIndex].last_message_time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                window.contacts = contacts;
                renderContacts(contacts);
            }
        }

        // ... existing code ...
        // Function to update a contact's last message and timestamp
        function updateContactLastMessage(contactId, message, timestamp) {
            const contact = document.querySelector(`.contact[data-contact-id="${contactId}"]`);
            if (contact) {
                const messagePreview = contact.querySelector('.contact-message');
                const timeElement = contact.querySelector('.message-time');
                if (messagePreview) {
                    messagePreview.textContent = message;
                }
                if (timeElement) {
                    timeElement.textContent = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }

                // Update the contact's timestamp in the global contacts array
                if (window.userContacts) {
                    const contactData = window.userContacts.find(c => c[0] == contactId);
                    if (contactData) {
                        contactData.last_message = message;
                        contactData.last_message_timestamp = timestamp;
                        contactData.last_message_time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                }

                // Move contact to top of list
                const contactList = contact.parentElement;
                contactList.insertBefore(contact, contactList.firstChild);
            }
        }

        // Update WebSocket event handlers
        socket.on('new_message', function(data) {
            console.log('Received new_message:', data);
            
            const currentChatId = window.currentChat?.id;
            const currentChatType = window.currentChat?.type;
            const isFromCurrentUser = data.sender_id == document.documentElement.getAttribute('data-user-id');
            const timestamp = data.timestamp || Date.now();
            
            // Update contact list for the sender
            if (!isFromCurrentUser) {
                updateContactLastMessage(data.sender_id, data.message, timestamp);
            }
            
            // Handle message display in chat
            if (data.group_id) {
                // ... existing group message handling code ...
            } else if (data.sender_id) {
                if (currentChatType === 'direct' && currentChatId == data.sender_id) {
                    const chatBody = document.querySelector('.chat-body');
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message received';
                    
                    messageElement.innerHTML = `
                        <div class="message-content">${data.message}</div>
                        <span class="message-timestamp">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                } else {
                    showNotification(`New message from ${data.sender_username}: ${data.message}`);
                }
            }
        });

        socket.on('message_sent', function(data) {
            console.log('Message sent confirmation:', data);
            const timestamp = data.timestamp || Date.now();
            
            // Update contact list for the receiver
            updateContactLastMessage(data.receiver_id, data.message, timestamp);
            
            // Store the last active chat
            storeLastActiveChat(data.receiver_id, 'direct', data.receiver_username);
        });

        // Function to create contact element (update the existing function)
        function createContactElement(contact, userDetail = null) {
            const contactId = contact[0];
            const contactElement = document.createElement('div');
            contactElement.className = 'contact';
            contactElement.setAttribute('data-contact-id', contactId);
            
            let displayName = userDetail?.username || contact[1] || 'Unknown User';
            let lastMessage = userDetail?.last_message || '';
            let lastMessageTime = userDetail?.last_message_time || '';
            
            // Use data URI for default avatar
            const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2U5ZWRlZiI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgM2MyLjY3IDAgNC44NCAyLjE3IDQuODQgNC44NFMxNC42NyAxNC42OCAxMiAxNC42OCA3LjE2IDEyLjUxIDcuMTYgOS44NCA5LjMzIDUgMTIgNXptMCAxM2MtMi4zMyAwLTQuMzEtLjgtNS45My0yLjQyLjg0LTEuNzEgMi41NS0yLjg4IDQuNTItMi44OCAxLjk3IDAgMy42OCAxLjE3IDQuNTIgMi44OEMxMy42OSAxNy4yIDExLjcgMTggOS4zNyAxOHoiLz48L3N2Zz4=';
            
            // Fix avatar path handling
            let profilePic;
            if (userDetail?.profile_picture) {
                profilePic = `/uploads/profile_photos/${userDetail.profile_picture}`;
            } else {
                profilePic = defaultAvatar;
            }

            contactElement.innerHTML = `
                <div class="profile-pic">
                    <img src="${profilePic}" alt="${displayName}" onerror="this.src='${defaultAvatar}'">
                </div>
                <div class="contact-info">
                    <div class="contact-name">${displayName}</div>
                    <div class="contact-message">${lastMessage}</div>
                </div>
                <div class="contact-meta">
                    <div class="message-time">${lastMessageTime}</div>
                </div>
            `;

            contactElement.onclick = () => startChatWithContact(contactId, displayName);
            return contactElement;
        }

        // Profile functionality
        function loadProfileData() {
            fetch('/api/user/profile')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('profile-nickname').textContent = data.username;
                    document.getElementById('profile-name-input').value = data.name || '';
                    document.getElementById('profile-bio-input').value = data.bio || '';
                    if (data.profile_picture) {
                        document.getElementById('profile-avatar-img').src = `/uploads/profile_photos/${data.profile_picture}`;
                    }
                })
                .catch(error => console.error('Error loading profile:', error));
        }

        // Handle profile name updates
        const nameInput = document.getElementById('profile-name-input');
        let nameTimeout;
        nameInput.addEventListener('input', () => {
            clearTimeout(nameTimeout);
            nameTimeout = setTimeout(() => {
                const newName = nameInput.value;
                fetch('/api/user/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: newName })
                })
                .catch(error => console.error('Error updating name:', error));
            }, 500);
        });

        // Handle profile bio updates
        const bioInput = document.getElementById('profile-bio-input');
        let bioTimeout;
        bioInput.addEventListener('input', () => {
            clearTimeout(bioTimeout);
            bioTimeout = setTimeout(() => {
                const newBio = bioInput.value;
                fetch('/api/user/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ bio: newBio })
                })
                .catch(error => console.error('Error updating bio:', error));
            }, 500);
        });

        // Handle profile picture updates
        const avatarEdit = document.querySelector('.avatar-edit');
        avatarEdit.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('profile_picture', file);
                    
                    fetch('/api/user/update-profile-picture', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('profile-avatar-img').src = `/uploads/profile_photos/${data.filename}`;
                        }
                    })
                    .catch(error => console.error('Error updating profile picture:', error));
                }
            };
            input.click();
        });

        // Handle logout
        document.getElementById('logout-button').addEventListener('click', () => {
            fetch('/auth/logout', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/';
                }
            })
            .catch(error => console.error('Error logging out:', error));
        });

        // Load profile data when settings sidebar is opened
        const settingsSidebar = document.querySelector('.settings-sidebar');
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'style') {
                    if (settingsSidebar.style.display !== 'none') {
                        loadProfileData();
                    }
                }
            });
        });

        observer.observe(settingsSidebar, {
            attributes: true
        });
    </script>
</body>
</html>