<!DOCTYPE html>
<html lang="en" 
    {% if session and session.user_id %}
    data-user-id="{{ session.user_id }}"
    data-authenticated="true"
    {% else %}
    data-authenticated="false"
    {% endif %}
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TogolohChat</title>
    <!-- Include Socket.IO client library -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #111b21;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        
        .sidebar {
            width: 30%;
            background-color: #111b21;
            border-right: 1px solid #222d34;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 10px;
            background-color: #1f2c33;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        
        .app-name {
            color: #e9edef;
            font-size: 16px;
            font-weight: bold;
        }
        
        .sidebar-header-icons {
            display: flex;
            gap: 15px;
        }
        
        .search-container {
            padding: 8px;
            background-color: #111b21;
        }
        
        .search-bar {
            background-color: #202c33;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
        }
        
        .search-bar input {
            background: transparent;
            border: none;
            color: #d1d7db;
            width: 100%;
            outline: none;
            margin-left: 10px;
            font-size: 15px;
        }
        
        .contact-list {
            overflow-y: auto;
            flex: 1;
        }
        
        /* Contact styles that were accidentally removed */
        .contact {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #222d34;
            cursor: pointer;
        }
        
        .contact:hover {
            background-color: #202c33;
        }
        
        .contact-active {
            background-color: #2a3942;
        }
        
        .profile-pic {
            width: 49px;
            height: 49px;
            border-radius: 50%;
            margin-right: 15px;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-name {
            color: #e9edef;
            font-size: 17px;
            margin-bottom: 3px;
        }
        
        .contact-message {
            color: #8696a0;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 45px;
        }
        
        .message-time {
            color: #8696a0;
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        /* Sidebar Navigation */
        .sidebar-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #1f2c33;
            height: 60px;
            width: 100%;
            border-top: 1px solid #222d34;
            margin-top: auto; /* Push to bottom of sidebar */
        }
        
        .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #8696a0;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        
        .nav-icon:hover {
            background-color: #2a3942;
        }
        
        .nav-icon.active {
            color: #00a884;
        }
        
        .nav-icon svg {
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
        }
        
        .nav-icon-label {
            font-size: 12px;
        }
        
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #0b141a;
            position: relative;
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background-color: #202c33;
            height: 60px;
        }
        
        .chat-header-info {
            flex: 1;
            margin-left: 15px;
        }
        
        .chat-header-name {
            color: #e9edef;
            font-size: 16px;
        }
        
        .chat-header-status {
            color: #8696a0;
            font-size: 13px;
        }
        
        .chat-header-icons {
            display: flex;
            gap: 20px;
            color: #aebac1;
        }
        
        .chat-body {
            flex: 1;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: contain;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 65%;
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
        }
        
        .received {
            background-color: #202c33;
            color: #e9edef;
            align-self: flex-start;
            border-top-left-radius: 0;
        }
        
        .sent {
            background-color: #005c4b;
            color: #e9edef;
            align-self: flex-end;
            border-top-right-radius: 0;
        }
        
        .message-content {
            font-size: 14px;
            margin-right: 40px;
        }
        
        .message-timestamp {
            position: absolute;
            bottom: 5px;
            right: 7px;
            color: #8696a0;
            font-size: 11px;
        }
        
        .chat-footer {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #202c33;
        }
        
        .chat-footer-icons {
            display: flex;
            gap: 15px;
            color: #8696a0;
            padding: 0 15px;
        }
        
        .message-input {
            flex: 1;
            background-color: #2a3942;
            border-radius: 8px;
            border: none;
            padding: 9px 12px;
            color: #d1d7db;
            outline: none;
            font-size: 15px;
        }
        
        .send-button {
            margin-left: 10px;
            color: #8696a0;
            cursor: pointer;
        }
        
        .icon {
            cursor: pointer;
        }
        
        /* Content Areas */
        .content-area {
            display: none;
            flex: 1;
            flex-direction: column;
        }
        
        .content-area.active {
            display: flex;
        }
        
        .contacts-area {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Contacts screen */
        .contacts-header {
            padding: 16px;
            background-color: #1f2c33;
            color: #e9edef;
            font-size: 20px;
            font-weight: bold;
        }
        
        /* Utility Classes */
        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                display: none;
            }
            
            .main-chat {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar will be handled by you -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-name">TogolohChat</div>
                <div class="sidebar-header-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M12 20.664a8.664 8.664 0 0 1-8.664-8.664A8.664 8.664 0 0 1 12 3.336a8.664 8.664 0 0 1 8.664 8.664A8.664 8.664 0 0 1 12 20.664zm0-17.328a8.664 8.664 0 0 0-8.664 8.664A8.664 8.664 0 0 0 12 20.664a8.664 8.664 0 0 0 8.664-8.664A8.664 8.664 0 0 0 12 3.336z"></path>
                        <path fill="currentColor" d="M12 14.504c-1.104 0-2-.896-2-2s.896-2 2-2 2 .896 2 2-.896 2-2 2zm0-5c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-bar">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                    </svg>
                    <input type="text" id="search-input" placeholder="Іздеу же жаңы чат баштоо..." onkeyup="searchContacts()">
                </div>
            </div>
            
            <div class="contact-list" id="contact-list">
                <!-- Contacts will be loaded dynamically -->
                <div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">
                    Loading contacts...
                </div>
            </div>
            
            <!-- Sidebar Navigation (moved from bottom) -->
            <div class="sidebar-nav">
                <div class="nav-icon active" data-target="contacts">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"></path>
                    </svg>
                    <span class="nav-icon-label">Contacts</span>
                </div>
                <div class="nav-icon" data-target="groups">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"></path>
                    </svg>
                    <span class="nav-icon-label">Groups</span>
                </div>
                <div class="nav-icon" data-target="add">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                    <span class="nav-icon-label">Add</span>
                </div>
                <div class="nav-icon" data-target="settings">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                    </svg>
                    <span class="nav-icon-label">Settings</span>
                </div>
            </div>
        </div>
        
        <!-- Settings Sidebar -->
        <div class="settings-sidebar" style="display: none; width: 30%; background-color: #111b21; border-right: 1px solid #222d34; flex-direction: column; position: absolute; top: 0; left: 0; height: calc(100% - 60px); z-index: 100;">
            <div class="sidebar-header">
                <div class="sidebar-header-back" style="cursor: pointer;">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19.8 11H7.5l5.6-5.6L11.7 4l-8 8 8 8 1.4-1.4L7.5 13h12.3v-2z"></path>
                    </svg>
                </div>
                <div class="app-name">Settings</div>
                <div class="close-settings" style="cursor: pointer; margin-left: auto;">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                    </svg>
                </div>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 15px;">
                <div class="settings-option" style="background-color: #202c33; padding: 15px; border-radius: 8px; margin-bottom: 15px; cursor: pointer;">
                    <div style="display: flex; align-items: center;">
                        <svg viewBox="0 0 24 24" width="24" height="24" style="margin-right: 15px;">
                            <path fill="currentColor" d="M12 22.0005C5.07 22.0005 1.5 18.5205 1.5 12.0005C1.5 5.48047 5.07 2.00047 12 2.00047C18.93 2.00047 22.5 5.48047 22.5 12.0005C22.5 18.5205 18.93 22.0005 12 22.0005ZM12 3.50047C5.82 3.50047 3 6.24047 3 12.0005C3 17.7605 5.82 20.5005 12 20.5005C18.18 20.5005 21 17.7605 21 12.0005C21 6.24047 18.18 3.50047 12 3.50047ZM15.53 13.8805C15.82 13.2405 16 12.9505 16 12.0005C16 11.0505 15.82 10.7605 15.53 10.1205C15.37 9.78047 15.1 9.50047 14.79 9.27047C14.43 9.00047 14.25 8.77047 14.25 7.75047V7.50047C14.25 6.94047 13.81 6.50047 13.25 6.50047H10.75C10.19 6.50047 9.75 6.94047 9.75 7.50047V7.72047C9.75 8.69047 9.59 8.87047 9.33 9.11047C9 9.42047 8.71 9.75047 8.5 10.1705C8.19 10.8005 8 11.1505 8 12.0005C8 12.8505 8.19 13.1905 8.48 13.7905C8.71 14.1905 9 14.5305 9.34 14.8505C9.58 15.0605 9.75 15.2805 9.75 16.2405V16.5005C9.75 17.0605 10.19 17.5005 10.75 17.5005H13.25C13.81 17.5005 14.25 17.0605 14.25 16.5005V16.2405C14.25 15.2805 14.41 15.0605 14.67 14.8305C15 14.5305 15.3 14.2005 15.53 13.8805ZM12 14.0005C10.9 14.0005 10 13.1005 10 12.0005C10 10.9005 10.9 10.0005 12 10.0005C13.1 10.0005 14 10.9005 14 12.0005C14 13.1005 13.1 14.0005 12 14.0005Z"></path>
                        </svg>
                        <span style="color: #e9edef; font-size: 16px;">Change Language</span>
                    </div>
                </div>
                
                <div class="settings-option" style="background-color: #202c33; padding: 15px; border-radius: 8px; margin-bottom: 15px; cursor: pointer;">
                    <div style="display: flex; align-items: center;">
                        <svg viewBox="0 0 24 24" width="24" height="24" style="margin-right: 15px;">
                            <path fill="currentColor" d="M17 9.00033V7.40033C17 4.41033 14.73 2.00033 12 2.00033C9.27 2.00033 7 4.41033 7 7.40033V9.00033H5V21.0003H19V9.00033H17ZM10.5 7.40033C10.5 6.29033 11.13 5.40033 12 5.40033C12.87 5.40033 13.5 6.29033 13.5 7.40033V9.00033H10.5V7.40033ZM16.5 19.5003H7.5V10.5003H16.5V19.5003Z"></path>
                        </svg>
                        <span style="color: #e9edef; font-size: 16px;">Change Password</span>
                    </div>
                </div>
                
                <div class="settings-option" style="background-color: #202c33; padding: 15px; border-radius: 8px; cursor: pointer;">
                    <div style="display: flex; align-items: center;">
                        <svg viewBox="0 0 24 24" width="24" height="24" style="margin-right: 15px;">
                            <path fill="currentColor" d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM12 11.99H19C18.47 16.11 15.72 19.78 12 20.93V12H5V6.3L12 3.19V11.99Z"></path>
                        </svg>
                        <span style="color: #e9edef; font-size: 16px;">Admin Panel</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-chat">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="profile-pic">
                    <img src="/api/placeholder/49/49" alt="Profile">
                </div>
                <div class="chat-header-info">
                    <div class="chat-header-name">Umar1</div>
                    <div class="chat-header-status">online</div>
                </div>
                <div class="chat-header-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M15.9 14.3H15l-.3-.3c1-1.1 1.6-2.7 1.6-4.3 0-3.7-3-6.7-6.7-6.7S3 6 3 9.7s3 6.7 6.7 6.7c1.6 0 3.2-.6 4.3-1.6l.3.3v.8l5.1 5.1 1.5-1.5-5-5.2zm-6.2 0c-2.6 0-4.6-2.1-4.6-4.6s2.1-4.6 4.6-4.6 4.6 2.1 4.6 4.6-2 4.6-4.6 4.6z"></path>
                    </svg>
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"></path>
                    </svg>
                </div>
            </div>
            
            <!-- Chat Body -->
            <div class="chat-body">
                <div class="message received">
                    <div class="message-content">Umar d</div>
                    <span class="message-timestamp">22:00</span>
                </div>
                
                <div class="message sent">
                    <div class="message-content">hello</div>
                    <span class="message-timestamp">22:00</span>
                </div>
                
                <div class="message sent">
                    <div class="message-content">no its sno</div>
                    <span class="message-timestamp">22:00</span>
                </div>
                
                <div class="message sent">
                    <div class="message-content">aaw</div>
                    <span class="message-timestamp">22:00</span>
                </div>
                
                <div class="message sent">
                    <div class="message-content">wdwdwd</div>
                    <span class="message-timestamp">22:00</span>
                </div>
                
                <div class="message received">
                    <div class="message-content">chachacha</div>
                    <span class="message-timestamp">22:00</span>
                </div>
                
                <div class="message sent">
                    <div class="message-content">kkk</div>
                    <span class="message-timestamp">22:00</span>
                </div>
                
                <div class="message received">
                    <div class="message-content">I am at the shit</div>
                    <span class="message-timestamp">22:00</span>
                </div>
                
                <div class="message sent">
                    <div class="message-content">efef</div>
                    <span class="message-timestamp">22:00</span>
                </div>
            </div>
            
            <!-- Chat Footer -->
            <div class="chat-footer">
                <div class="chat-footer-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M9.153 11.603c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962zm-3.204 1.362c-.026-.307-.131 5.218 6.063 5.551 6.066-.25 6.066-5.551 6.066-5.551-6.078 1.416-12.129 0-12.129 0zm11.363 1.108s-.669 1.959-5.051 1.959c-3.505 0-5.388-1.164-5.607-1.959 0 0 5.912 1.055 10.658 0zM11.804 1.011C5.609 1.011.978 6.033.978 12.228s4.826 10.761 11.021 10.761S23.02 18.423 23.02 12.228c.001-6.195-5.021-11.217-11.216-11.217zM12 21.354c-5.273 0-9.381-3.886-9.381-9.159s3.942-9.548 9.215-9.548 9.548 4.275 9.548 9.548c-.001 5.272-4.109 9.159-9.382 9.159zm3.108-9.751c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962z"></path>
                    </svg>
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M1.816 15.556v.002c0 1.502.584 2.912 1.646 3.972s2.472 1.647 3.974 1.647a5.58 5.58 0 0 0 3.972-1.645l9.547-9.548c.769-.768 1.147-1.767 1.058-2.817-.079-.968-.548-1.927-1.319-2.698-1.594-1.592-4.068-1.711-5.517-.262l-7.916 7.915c-.881.881-.792 2.25.214 3.261.959.958 2.423 1.053 3.263.215l5.511-5.512c.28-.28.267-.722.053-.936l-.244-.244c-.191-.191-.567-.349-.957.04l-5.506 5.506c-.18.18-.635.127-.976-.214-.098-.097-.576-.613-.213-.973l7.915-7.917c.818-.817 2.267-.699 3.23.262.5.501.802 1.1.849 1.685.051.573-.156 1.111-.589 1.543l-9.547 9.549a3.97 3.97 0 0 1-2.829 1.171 3.975 3.975 0 0 1-2.83-1.173 3.973 3.973 0 0 1-1.172-2.828c0-1.071.415-2.076 1.172-2.83l7.209-7.211c.157-.157.264-.579.028-.814L11.5 4.36a.572.572 0 0 0-.834.018l-7.205 7.207a5.577 5.577 0 0 0-1.645 3.971z"></path>
                    </svg>
                </div>
                
                <input type="text" class="message-input" placeholder="Қабарыңызды жазыңыз">
                
                <div class="send-button">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Initialize current chat variable
        window.currentChat = null;
        
        // Socket connection events
        socket.on('connect', function() {
            console.log('Connected to server');
            
            // Get user information from HTML data attributes
            const htmlElement = document.documentElement;
            const isAuthenticated = htmlElement.getAttribute('data-authenticated') === 'true';
            
            // Join user's personal room for direct messages if authenticated
            if (isAuthenticated) {
                const userId = htmlElement.getAttribute('data-user-id');
                socket.emit('join', { room: userId });
                console.log('Joined personal room:', userId);
                
                // Load contacts for the authenticated user
                loadContacts();
            } else {
                console.log('Not authenticated, no room to join');
            }
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
        });
        
        // Handle notifications
        socket.on('notification', function(data) {
            console.log('Received notification:', data);
            
            if (data.type === 'contact_added') {
                // Show a notification toast
                showNotification(data.message, 'success');
                
                // Reload contacts to show the new contact
                loadContacts();
            }
            else if (data.type === 'added_to_group') {
                // Show a notification toast
                showNotification(data.message, 'success');
                
                // Reload contacts list to show the new group 
                loadContacts();
                
                // If currently in groups view, reload the groups
                if (document.querySelector('.nav-icon[data-target="groups"]').classList.contains('active')) {
                    loadGroups();
                }
            }
        });
        
        // Handle new message event from Socket.IO for both direct and group messages
        socket.on('new_message', function(data) {
            console.log('Received message:', data);
            
            // Check if this is for the currently open chat
            const currentChatId = window.currentChat?.id;
            const currentChatType = window.currentChat?.type;
            
            // If message is for a group
            if (data.group_id) {
                if (currentChatType === 'group' && currentChatId == data.group_id) {
                    // This message is for the current group chat
                    const chatBody = document.querySelector('.chat-body');
                    
                    // Create message element - show sender name if it's not from the current user
                    const messageElement = document.createElement('div');
                    
                    // Check if this is from the current user
                    const isFromCurrentUser = data.sender_id == document.documentElement.getAttribute('data-user-id');
                    messageElement.className = isFromCurrentUser ? 'message sent' : 'message received';
                    
                    // For received messages in groups, we show sender name
                    let senderName = '';
                    if (!isFromCurrentUser) {
                        senderName = `<div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${data.sender_username}</div>`;
                    }
                    
                    messageElement.innerHTML = `
                        ${senderName}
                        <div class="message-content">${data.message}</div>
                        <span class="message-timestamp">${data.timestamp || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                } else {
                    // This message is for another group - show notification
                    showNotification(`New message in group: ${data.message}`);
                }
            } else {
                // This is a direct message
                if (currentChatType === 'direct' && currentChatId == data.sender_id) {
                    // Message is for the current chat
                    const chatBody = document.querySelector('.chat-body');
                    
                    // Create message element
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message received';
                    messageElement.innerHTML = `
                        <div class="message-content">${data.message}</div>
                        <span class="message-timestamp">${data.timestamp || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                    // Update message status
                    socket.emit('update_message_status', {
                        message_id: data.message_id,
                        status: 'read',
                        chat_id: data.sender_id,
                        chat_type: 'direct'
                    });
                } else {
                    // Message is from someone else - show notification
                    showNotification(`${data.sender_username}: ${data.message}`);
                }
            }
        });
        
        // Function to load contacts and groups from the backend
        function loadContacts() {
            const contactList = document.getElementById('contact-list');
            contactList.innerHTML = '<div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">Loading chats...</div>';
            
            // Create a promise array to load both contacts and groups
            const promises = [
                fetch('/chat/contacts').then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    return response.json();
                }),
                fetch('/chat/groups').then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load groups');
                    }
                    return response.json();
                }),
                fetch('/chat/user_info').then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load user info');
                    }
                    return response.json();
                })
            ];
            
            // Wait for all data to load
            Promise.all(promises)
                .then(([contacts, groups, users]) => {
                    contactList.innerHTML = ''; // Clear loading message
                    
                    // Create a map of user IDs to user details
                    const userMap = {};
                    users.forEach(user => {
                        userMap[user.id] = user;
                    });
                    
                    // If no contacts and no groups, show message
                    if (contacts.length === 0 && groups.length === 0) {
                        contactList.innerHTML = '<div class="no-contacts" style="color: #8696a0; text-align: center; padding: 20px;">No chats found. Add contacts or create a group to start chatting.</div>';
                        return;
                    }
                    
                    // Create contact elements (direct chats)
                    contacts.forEach((contact) => {
                        const contactId = contact[0];
                        const displayName = contact[1] || (userMap[contactId] ? userMap[contactId].username : 'Unknown User');
                        
                        // Create contact element
                        const contactElement = document.createElement('div');
                        contactElement.className = 'contact';
                        contactElement.setAttribute('data-user-id', contactId);
                        contactElement.setAttribute('data-chat-type', 'direct');
                        
                        // Get user profile picture if available
                        const profilePic = userMap[contactId] && userMap[contactId].profile_picture 
                            ? `/uploads/profile_photos/${userMap[contactId].profile_picture}` 
                            : '/api/placeholder/49/49';
                        
                        contactElement.innerHTML = `
                            <div class="profile-pic">
                                <img src="${profilePic}" alt="${displayName}">
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">${displayName}</div>
                                <div class="contact-message">Direct message</div>
                            </div>
                            <div class="contact-meta">
                                <div class="message-time"></div>
                            </div>
                        `;
                        
                        // Add click event listener for direct chats
                        contactElement.addEventListener('click', handleContactClick);
                        
                        // Add to contact list
                        contactList.appendChild(contactElement);
                    });
                    
                    // Create group elements (group chats)
                    groups.forEach((group) => {
                        const groupElement = document.createElement('div');
                        groupElement.className = 'contact';
                        groupElement.setAttribute('data-group-id', group.id);
                        groupElement.setAttribute('data-chat-type', 'group');
                        
                        // Get group profile picture if available
                        const profilePic = group.picture 
                            ? `/uploads/group_images/${group.picture}` 
                            : '/api/placeholder/49/49';
                        
                        groupElement.innerHTML = `
                            <div class="profile-pic">
                                <img src="${profilePic}" alt="${group.name}">
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">${group.name}</div>
                                <div class="contact-message">Group · ${group.member_count} members</div>
                            </div>
                            <div class="contact-meta">
                                ${group.is_admin ? '<div class="admin-badge" style="color: #00a884; font-size: 12px;">Admin</div>' : ''}
                            </div>
                        `;
                        
                        // Add click event listener for group chats
                        groupElement.addEventListener('click', function() {
                            // Remove active class from all contacts
                            document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
                            // Add active class to clicked group
                            this.classList.add('contact-active');
                            
                            // Load the group chat
                            loadGroupChat(group.id);
                        });
                        
                        // Add to contact list
                        contactList.appendChild(groupElement);
                    });
                    
                    // If we have contacts or groups, make the first one active
                    if (contacts.length > 0 || groups.length > 0) {
                        const firstChat = document.querySelector('.contact');
                        if (firstChat) {
                            firstChat.click();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading chats:', error);
                    contactList.innerHTML = '<div class="error-message" style="color: #ff6b6b; text-align: center; padding: 20px;">Failed to load chats. Please refresh and try again.</div>';
                });
        }
        
        // Function to handle contact click
        function handleContactClick() {
            // Remove active class from all contacts
            document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
            // Add active class to clicked contact
            this.classList.add('contact-active');
            
            // Get contact details
            const contactName = this.querySelector('.contact-name').textContent;
            const contactId = this.getAttribute('data-user-id');
            
            console.log(`Loading chat with ${contactName}, ID: ${contactId}`);
            
            // Update the chat header with the selected contact's info
            document.querySelector('.chat-header-name').textContent = contactName;
            
            // Clear the current chat
            const chatBody = document.querySelector('.chat-body');
            chatBody.innerHTML = '';
            
            // Show loading indicator
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message';
            loadingElement.style.alignSelf = 'center';
            loadingElement.textContent = 'Loading messages...';
            chatBody.appendChild(loadingElement);
            
            // Fetch messages for this contact from the backend
            fetch(`/chat/get_messages/${contactId}`)
                .then(response => response.json())
                .then(messages => {
                    // Remove loading indicator
                    chatBody.innerHTML = '';
                    
                    // If no messages, show a welcome message
                    if (messages.length === 0) {
                        const welcomeElement = document.createElement('div');
                        welcomeElement.className = 'message';
                        welcomeElement.style.alignSelf = 'center';
                        welcomeElement.style.backgroundColor = '#202c33';
                        welcomeElement.style.padding = '10px 15px';
                        welcomeElement.style.borderRadius = '8px';
                        welcomeElement.style.color = '#e9edef';
                        welcomeElement.textContent = `Start chatting with ${contactName}`;
                        chatBody.appendChild(welcomeElement);
                    } else {
                        // Add messages to the chat
                        messages.forEach(msg => {
                            const [senderId, receiverId, msgContent, timestamp] = msg;
                            
                            // Check if this is a sent or received message
                            const isSent = senderId.toString() === document.documentElement.getAttribute('data-user-id');
                            
                            // Create message element
                            const messageElement = document.createElement('div');
                            messageElement.className = isSent ? 'message sent' : 'message received';
                            messageElement.innerHTML = `
                                <div class="message-content">${msgContent}</div>
                                <span class="message-timestamp">${timestamp}</span>
                            `;
                            
                            chatBody.appendChild(messageElement);
                        });
                    }
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    chatBody.innerHTML = '';
                    
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message';
                    errorElement.style.alignSelf = 'center';
                    errorElement.style.backgroundColor = '#8B0000';
                    errorElement.style.padding = '10px 15px';
                    errorElement.style.borderRadius = '8px';
                    errorElement.style.color = '#ffffff';
                    errorElement.textContent = 'Error loading messages. Please try again.';
                    chatBody.appendChild(errorElement);
                });
        }
        
        // Function to search contacts
        function searchContacts() {
            const searchInput = document.getElementById('search-input');
            const filter = searchInput.value.toLowerCase();
            const contacts = document.querySelectorAll('.contact');
            
            contacts.forEach(contact => {
                const name = contact.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    contact.style.display = '';
                } else {
                    contact.style.display = 'none';
                }
            });
            
            // Show no results message if all contacts are hidden
            const visibleContacts = Array.from(contacts).filter(c => c.style.display !== 'none');
            const contactList = document.getElementById('contact-list');
            const noResultsMsg = contactList.querySelector('.no-results');
            
            if (visibleContacts.length === 0 && filter) {
                if (!noResultsMsg) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.style.color = '#8696a0';
                    noResults.style.textAlign = 'center';
                    noResults.style.padding = '20px';
                    noResults.textContent = `No contacts found for "${filter}"`;
                    contactList.appendChild(noResults);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // Basic functionality for sending messages
        document.querySelector('.send-button').addEventListener('click', function() {
            const messageInput = document.querySelector('.message-input');
            const message = messageInput.value.trim();
            
            if (message && window.currentChat) {
                // Format timestamp
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const time = `${hours}:${minutes}`;
                
                // Create a message id for tracking
                const messageId = Date.now().toString();
                
                // Add message to UI
                const chatBody = document.querySelector('.chat-body');
                const messageElement = document.createElement('div');
                messageElement.className = 'message sent';
                messageElement.setAttribute('data-message-id', messageId);
                messageElement.innerHTML = `
                    <div class="message-content">${message}</div>
                    <span class="message-timestamp">${time}</span>
                `;
                
                chatBody.appendChild(messageElement);
                messageInput.value = '';
                
                // Scroll to bottom
                chatBody.scrollTop = chatBody.scrollHeight;
                
                // Send message based on chat type
                if (window.currentChat.type === 'direct') {
                    // Direct message
                    socket.emit('send_message', {
                        receiver_id: window.currentChat.id,
                        receiver_username: window.currentChat.name,
                        message: message,
                        timestamp: time,
                        message_id: messageId
                    });
                } else {
                    // Group message - only use Socket.IO to avoid duplicate messages
                    socket.emit('send_message', {
                        group_id: window.currentChat.id,
                        message: message,
                        timestamp: time,
                        message_id: messageId
                    });
                    
                    // Removed duplicate HTTP API call to prevent double-sending
                }
            }
        });
        
        // Send message on Enter key
        document.querySelector('.message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.querySelector('.send-button').click();
            }
        });
        
        // Bottom navigation functionality
        const navIcons = document.querySelectorAll('.nav-icon');
        navIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                // Remove active class from all nav icons
                navIcons.forEach(i => i.classList.remove('active'));
                // Add active class to clicked icon
                this.classList.add('active');
                
                const target = this.getAttribute('data-target');
                console.log(`Switching to ${target} view`);
                
                // Handle specific targets
                if (target === 'add') {
                    // Show a modal to add a new contact
                    showAddContactModal();
                } else if (target === 'contacts') {
                    // Refresh contacts and show both contacts and groups
                    loadContacts();
                } else if (target === 'groups') {
                    // Show dedicated groups view
                    showGroupsView();
                } else if (target === 'settings') {
                    // Show settings sidebar
                    showSettingsSidebar();
                }
            });
        });
        
        // Function to show the add contact modal
        function showAddContactModal() {
            // Get the sidebar
            const sidebar = document.querySelector('.sidebar');
            
            // Save the current sidebar content
            const originalContent = sidebar.innerHTML;
            
            // Create and show the add contact interface in the sidebar
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-contacts" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Add New Contact</div>
                    </div>
                </div>
                
                <div style="padding: 15px; background-color: #111b21;">
                    <div style="margin-bottom: 15px;">
                        <label for="search-user" style="display: block; color: #e9edef; margin-bottom: 5px;">Find User by Username or Email</label>
                        <div style="display: flex;">
                            <input type="text" id="search-user" style="flex: 1; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px 0 0 5px;" placeholder="Enter username or email">
                            <button id="search-user-btn" style="padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 0 5px 5px 0; cursor: pointer;">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="search-results" style="overflow-y: auto; flex: 1; background-color: #111b21;">
                    <div style="text-align: center; color: #8696a0; padding: 20px;">
                        Search for users to add as contacts
                    </div>
                </div>
            `;
            
            // Add event listeners
            document.getElementById('back-to-contacts').addEventListener('click', function() {
                // Restore original sidebar content
                sidebar.innerHTML = originalContent;
                
                // Reattach event listeners to contact elements
                reattachContactEventListeners();
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            });
            
            document.getElementById('search-user-btn').addEventListener('click', function() {
                const searchTerm = document.getElementById('search-user').value.trim();
                if (searchTerm) {
                    searchUsers(searchTerm);
                }
            });
            
            // Add keypress event to search input
            document.getElementById('search-user').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('search-user-btn').click();
                }
            });
        }
        
        // Function to search for users
        function searchUsers(searchTerm) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '<div style="text-align: center; color: #e9edef; padding: 20px;">Searching...</div>';
            
            fetch(`/chat/search_users?term=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(users => {
                    resultsContainer.innerHTML = '';
                    
                    if (users.length === 0) {
                        resultsContainer.innerHTML = '<div style="text-align: center; color: #e9edef; padding: 20px;">No users found</div>';
                        return;
                    }
                    
                    users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.style.padding = '10px 15px';
                        userElement.style.display = 'flex';
                        userElement.style.alignItems = 'center';
                        userElement.style.justifyContent = 'space-between';
                        userElement.style.borderBottom = '1px solid #222d34';
                        userElement.style.cursor = 'pointer';
                        
                        // Highlight on hover
                        userElement.addEventListener('mouseover', function() {
                            this.style.backgroundColor = '#202c33';
                        });
                        userElement.addEventListener('mouseout', function() {
                            this.style.backgroundColor = 'transparent';
                        });
                        
                        const profilePic = user.profile_picture 
                            ? `/uploads/profile_photos/${user.profile_picture}` 
                            : '/api/placeholder/40/40';
                            
                        userElement.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; margin-right: 10px;">
                                    <img src="${profilePic}" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div>
                                    <div style="color: #e9edef; font-weight: bold;">${user.username}</div>
                                    <div style="color: #8696a0; font-size: 12px;">${user.email || ''}</div>
                                </div>
                            </div>
                            <button class="add-user-btn" data-user-id="${user.id}" style="padding: 5px 10px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer;">Add</button>
                        `;
                        
                        resultsContainer.appendChild(userElement);
                        
                        // Add event listener to add button
                        userElement.querySelector('.add-user-btn').addEventListener('click', function(e) {
                            e.stopPropagation(); // Prevent triggering the parent click
                            const userId = this.getAttribute('data-user-id');
                            addContact(userId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error searching users:', error);
                    resultsContainer.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Error searching users</div>';
                });
        }
        
        // Function to add a contact
        function addContact(contactId) {
            fetch('/chat/add_contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ contact_id: contactId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Contact added") {
                    // Show success message
                    showNotification('Contact added successfully', 'success');
                    
                    // Reload contacts to show the new contact
                    if (document.querySelector('.nav-icon[data-target="contacts"]').classList.contains('active')) {
                        loadContacts();
                    }
                    
                    // Return to contacts view
                    const backButton = document.getElementById('back-to-contacts');
                    if (backButton) {
                        backButton.click();
                    }
                } else {
                    showNotification('Failed to add contact: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error adding contact:', error);
                showNotification('Failed to add contact. Please try again.', 'error');
            });
        }
        
        // Function to reattach event listeners to contacts after sidebar content is restored
        function reattachContactEventListeners() {
            // Reattach event listeners to search box
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keyup', searchContacts);
            }
            
            // Reattach event listeners to contacts
            document.querySelectorAll('.contact').forEach(contact => {
                contact.addEventListener('click', handleContactClick);
            });
        }
        
        // Function to show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            
            // Set color based on notification type
            let backgroundColor;
            switch(type) {
                case 'success':
                    backgroundColor = '#00a884';
                    break;
                case 'error':
                    backgroundColor = '#f15c6d';
                    break;
                case 'warning':
                    backgroundColor = '#ffa000';
                    break;
                default: // info
                    backgroundColor = '#005c4b';
            }
            
            notification.style.backgroundColor = backgroundColor;
            notification.style.color = 'white';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '300px';
            notification.style.wordBreak = 'break-word';
            notification.innerText = message;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(function() {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(function() {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 5000);
        }
        
        // Function to show groups view
        function showGroupsView() {
            // Get the sidebar
            const sidebar = document.querySelector('.sidebar');
            
            // Save the current sidebar content
            const originalContent = sidebar.innerHTML;
            
            // Update sidebar content with groups view
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <div class="app-name">Groups</div>
                    <div class="sidebar-header-icons">
                        <div id="create-group-button" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="search-container">
                    <div class="search-bar">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                        </svg>
                        <input type="text" id="group-search-input" placeholder="Search groups" onkeyup="searchGroups()">
                    </div>
                </div>
                
                <div id="groups-list" class="contact-list">
                    <div class="loading-groups" style="color: #8696a0; text-align: center; padding: 20px;">
                        Loading groups...
                    </div>
                </div>
            `;
            
            // Add event listener for creating new group
            document.getElementById('create-group-button').addEventListener('click', showCreateGroupView);
            
            // Load the user's groups
            loadGroups();
        }
        
        // Function to load the user's groups
        function loadGroups() {
            const groupsList = document.getElementById('groups-list');
            
            fetch('/chat/groups')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load groups');
                    }
                    return response.json();
                })
                .then(groups => {
                    groupsList.innerHTML = '';
                    
                    if (groups.length === 0) {
                        groupsList.innerHTML = '<div class="no-groups" style="color: #8696a0; text-align: center; padding: 20px;">No groups found. Create a new group to get started.</div>';
                        return;
                    }
                    
                    // Create group elements
                    groups.forEach((group, index) => {
                        const groupElement = document.createElement('div');
                        groupElement.className = 'contact'; // Reusing contact class for styling
                        groupElement.setAttribute('data-group-id', group.id);
                        
                        // Get group profile picture if available
                        const profilePic = group.picture 
                            ? `/uploads/group_images/${group.picture}` 
                            : '/api/placeholder/49/49';
                        
                        groupElement.innerHTML = `
                            <div class="profile-pic">
                                <img src="${profilePic}" alt="${group.name}">
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">${group.name}</div>
                                <div class="contact-message">${group.member_count} members</div>
                            </div>
                            <div class="contact-meta">
                                ${group.is_admin ? '<div class="admin-badge" style="color: #00a884; font-size: 12px;">Admin</div>' : ''}
                            </div>
                        `;
                        
                        // Add click event to load group chat
                        groupElement.addEventListener('click', function() {
                            loadGroupChat(group.id);
                        });
                        
                        groupsList.appendChild(groupElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading groups:', error);
                    groupsList.innerHTML = '<div class="error-message" style="color: #ff6b6b; text-align: center; padding: 20px;">Failed to load groups. Please refresh and try again.</div>';
                });
        }
        
        // Function to search groups
        function searchGroups() {
            const searchInput = document.getElementById('group-search-input');
            const filter = searchInput.value.toLowerCase();
            const groups = document.querySelectorAll('#groups-list .contact');
            
            groups.forEach(group => {
                const name = group.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    group.style.display = '';
                } else {
                    group.style.display = 'none';
                }
            });
            
            // Show no results message if all groups are hidden
            const visibleGroups = Array.from(groups).filter(g => g.style.display !== 'none');
            const groupsList = document.getElementById('groups-list');
            const noResultsMsg = groupsList.querySelector('.no-results');
            
            if (visibleGroups.length === 0 && filter) {
                if (!noResultsMsg) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.style.color = '#8696a0';
                    noResults.style.textAlign = 'center';
                    noResults.style.padding = '20px';
                    noResults.textContent = `No groups found for "${filter}"`;
                    groupsList.appendChild(noResults);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // Function to load a group chat
        function loadGroupChat(groupId) {
            // First, get the group info
            fetch(`/chat/group/${groupId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load group info');
                    }
                    return response.json();
                })
                .then(group => {
                    // Update the chat header with group info
                    updateChatHeader(group, true);
                    
                    // Join the group's Socket.IO room
                    socket.emit('join', { room: `group_${groupId}` });
                    
                    // Load group messages
                    loadGroupMessages(groupId);
                })
                .catch(error => {
                    console.error('Error loading group info:', error);
                    showNotification('Failed to load group chat', 'error');
                });
        }
        
        // Function to update the chat header with contact or group info
        function updateChatHeader(entity, isGroup = false) {
            const chatHeader = document.querySelector('.chat-header');
            
            // Store entity for later reference
            window.currentChat = {
                id: entity.id,
                type: isGroup ? 'group' : 'direct',
                name: isGroup ? entity.name : entity.username,
                entity: entity // Store the full entity for info panel
            };
            
            // Get profile picture
            const profilePic = isGroup
                ? (entity.picture ? `/uploads/group_images/${entity.picture}` : '/api/placeholder/49/49')
                : (entity.profile_picture ? `/uploads/profile_photos/${entity.profile_picture}` : '/api/placeholder/49/49');
            
            // Update header content
            chatHeader.innerHTML = `
                <div class="profile-pic" style="cursor: pointer;">
                    <img src="${profilePic}" alt="${isGroup ? entity.name : entity.username}">
                </div>
                <div class="chat-header-info" style="cursor: pointer;">
                    <div class="chat-header-name">${isGroup ? entity.name : entity.username}</div>
                    <div class="chat-header-status">${isGroup ? `${entity.member_count} members` : 'online'}</div>
                </div>
                <div class="chat-header-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M15.9 14.3H15l-.3-.3c1-1.1 1.6-2.7 1.6-4.3 0-3.7-3-6.7-6.7-6.7S3 6 3 9.7s3 6.7 6.7 6.7c1.6 0 3.2-.6 4.3-1.6l.3.3v.8l5.1 5.1 1.5-1.5-5-5.2zm-6.2 0c-2.6 0-4.6-2.1-4.6-4.6s2.1-4.6 4.6-4.6 4.6 2.1 4.6 4.6-2 4.6-4.6 4.6z"></path>
                    </svg>
                    <div class="info-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"></path>
                        </svg>
                    </div>
                </div>
            `;
            
            // Add event listener for profile click (both image and name/status area)
            const profileElements = [
                chatHeader.querySelector('.profile-pic'), 
                chatHeader.querySelector('.chat-header-info')
            ];
            
            profileElements.forEach(element => {
                element.addEventListener('click', function() {
                    if (isGroup) {
                        showGroupInfo(entity);
                    } else {
                        showUserInfo(entity);
                    }
                });
            });
            
            // Add event listener for info button
            chatHeader.querySelector('.info-button').addEventListener('click', function() {
                if (isGroup) {
                    showGroupInfo(entity);
                } else {
                    showUserInfo(entity);
                }
            });
        }
        
        // Function to load group messages
        function loadGroupMessages(groupId) {
            const chatBody = document.querySelector('.chat-body');
            chatBody.innerHTML = '';
            
            // Show loading indicator
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message';
            loadingElement.style.alignSelf = 'center';
            loadingElement.textContent = 'Loading messages...';
            chatBody.appendChild(loadingElement);
            
            // Fetch messages for this group
            fetch(`/chat/get_group_messages/${groupId}`)
                .then(response => response.json())
                .then(messages => {
                    // Remove loading indicator
                    chatBody.innerHTML = '';
                    
                    // If no messages, show a welcome message
                    if (messages.length === 0) {
                        const welcomeElement = document.createElement('div');
                        welcomeElement.className = 'message';
                        welcomeElement.style.alignSelf = 'center';
                        welcomeElement.style.backgroundColor = '#202c33';
                        welcomeElement.style.padding = '10px 15px';
                        welcomeElement.style.borderRadius = '8px';
                        welcomeElement.style.color = '#e9edef';
                        welcomeElement.textContent = `No messages yet in this group. Be the first to say hello!`;
                        chatBody.appendChild(welcomeElement);
                    } else {
                        // Add messages to the chat
                        messages.forEach(msg => {
                            // In group messages, we get [sender_id, message, time]
                            const [senderId, msgContent, timestamp] = msg;
                            
                            // Check if this is a sent or received message
                            const isSent = senderId.toString() === document.documentElement.getAttribute('data-user-id');
                            
                            // Create message element
                            const messageElement = document.createElement('div');
                            messageElement.className = isSent ? 'message sent' : 'message received';
                            
                            // For received messages in groups, we may want to show sender name
                            let senderName = '';
                            if (!isSent) {
                                // In a real app, you'd fetch the sender's name
                                // Here, we'll use a placeholder
                                senderName = `<div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">User ${senderId}</div>`;
                            }
                            
                            messageElement.innerHTML = `
                                ${senderName}
                                <div class="message-content">${msgContent}</div>
                                <span class="message-timestamp">${timestamp}</span>
                            `;
                            
                            chatBody.appendChild(messageElement);
                        });
                    }
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                    // Update the message input placeholder
                    document.querySelector('.message-input').placeholder = 'Type a message to the group...';
                })
                .catch(error => {
                    console.error('Error loading group messages:', error);
                    chatBody.innerHTML = '';
                    
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message';
                    errorElement.style.alignSelf = 'center';
                    errorElement.style.backgroundColor = '#8B0000';
                    errorElement.style.padding = '10px 15px';
                    errorElement.style.borderRadius = '8px';
                    errorElement.style.color = '#ffffff';
                    errorElement.textContent = 'Error loading messages. Please try again.';
                    chatBody.appendChild(errorElement);
                });
        }
        
        // Function to show group info
        function showGroupInfo(group) {
            // Create a modal to display group info
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'flex-end'; // Align to right side
            modal.style.alignItems = 'stretch';
            
            // Group profile picture
            const profilePic = group.picture ? `/uploads/group_images/${group.picture}` : '/api/placeholder/80/80';
            
            // Create side panel
            const panel = document.createElement('div');
            panel.className = 'group-info-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '350px';
            panel.style.maxWidth = '100%';
            panel.style.height = '100%';
            panel.style.overflowY = 'auto';
            panel.style.transition = 'transform 0.3s ease';
            panel.style.transform = 'translateX(100%)'; // Start offscreen
            panel.style.boxShadow = '-5px 0 15px rgba(0, 0, 0, 0.1)';
            
            // Check if user is admin
            const isAdmin = group.is_admin || group.admin_id === parseInt(document.documentElement.getAttribute('data-user-id'));
            
            panel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                    <div id="close-group-info" style="cursor: pointer; margin-right: 15px;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19.8 11H7.5l5.6-5.6L11.7 4l-8 8 8 8 1.4-1.4L7.5 13h12.3v-2z"></path>
                        </svg>
                    </div>
                    <h2 style="color: #e9edef; margin: 0;">Group Info</h2>
                </div>
                
                <div style="padding: 20px; text-align: center; border-bottom: 1px solid #2a3942;">
                    <div style="width: 150px; height: 150px; border-radius: 75px; overflow: hidden; margin: 0 auto 15px;">
                        <img src="${profilePic}" alt="${group.name}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h2 style="color: #e9edef; margin-bottom: 5px;">${group.name}</h2>
                    <p style="color: #8696a0; margin-bottom: 0;">Group · ${group.member_count} members</p>
                </div>
                
                ${group.description ? `
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: #e9edef; margin-bottom: 10px; font-size: 16px;">Description</h3>
                    <p style="color: #e9edef; margin: 0;">${group.description}</p>
                </div>
                ` : ''}
                
                ${isAdmin ? `
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <button id="add-members-btn" class="action-button" style="width: 100%; padding: 12px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        Add Members
                    </button>
                </div>
                ` : ''}
                
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: #e9edef; margin-bottom: 10px; font-size: 16px;">Members</h3>
                    <div id="group-members-list">
                        ${group.members.map(member => `
                            <div class="group-member" data-user-id="${member.id}" style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #2a3942; cursor: pointer;">
                                <div style="width: 40px; height: 40px; border-radius: 20px; overflow: hidden; margin-right: 15px;">
                                    <img src="${member.profile_picture ? `/uploads/profile_photos/${member.profile_picture}` : '/api/placeholder/40/40'}" alt="${member.username}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: #e9edef;">${member.username}</div>
                                    ${member.is_admin ? `<div style="color: #00a884; font-size: 12px;">Group Admin</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <button id="leave-group-btn" class="action-button" style="width: 100%; padding: 12px; background-color: #1f2c33; color: #f15c6d; border: 1px solid #2a3942; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        Leave Group
                    </button>
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add a slight delay for animation effect
            setTimeout(() => {
                panel.style.transform = 'translateX(0)';
            }, 10);
            
            // Close panel when button is clicked
            document.getElementById('close-group-info').addEventListener('click', function() {
                panel.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            });
            
            // Close panel when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    panel.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(modal);
                    }, 300);
                }
            });
            
            // Add click event to members to view their profile
            const memberElements = document.querySelectorAll('.group-member');
            memberElements.forEach(element => {
                element.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const member = group.members.find(m => m.id == userId);
                    
                    if (member) {
                        // Close current panel first
                        panel.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            document.body.removeChild(modal);
                            // Show user profile
                            showUserInfo(member);
                        }, 300);
                    }
                });
            });
            
            // Handle leave group action
            document.getElementById('leave-group-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to leave this group?')) {
                    // You would implement the actual leave group functionality here
                    showNotification('This feature is not yet implemented', 'warning');
                }
            });
            
            // Add members functionality (if admin)
            const addMembersBtn = document.getElementById('add-members-btn');
            if (addMembersBtn) {
                addMembersBtn.addEventListener('click', function() {
                    // Close the current panel
                    panel.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(modal);
                        // You would implement the add members functionality here
                        showAddGroupMembersView(group.id);
                    }, 300);
                });
            }
        }

        // Function to show add members to group view
        function showAddGroupMembersView(groupId) {
            // This function would be similar to the contact selection in showCreateGroupView
            showNotification('Add members functionality is not yet implemented', 'warning');
        }

        // Function to show create group view
        function showCreateGroupView() {
            // Get the sidebar
            const sidebar = document.querySelector('.sidebar');
            
            // Save the current sidebar content
            const originalContent = sidebar.innerHTML;
            
            // Update sidebar content with group creation view
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-groups" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Create New Group</div>
                    </div>
                </div>
                
                <div style="padding: 15px; background-color: #111b21;">
                    <form id="create-group-form">
                        <div style="margin-bottom: 15px;">
                            <label for="group-name" style="display: block; color: #e9edef; margin-bottom: 5px;">Group Name</label>
                            <input type="text" id="group-name" style="width: 100%; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px;" placeholder="Enter group name" required>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label for="group-description" style="display: block; color: #e9edef; margin-bottom: 5px;">Group Description (Optional)</label>
                            <textarea id="group-description" style="width: 100%; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px; resize: none; height: 80px;" placeholder="Enter group description"></textarea>
                        </div>
                        
                        <div>
                            <button type="submit" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                Next: Add Members
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Add event listener to back button
            document.getElementById('back-to-groups').addEventListener('click', function() {
                // Restore original sidebar content
                sidebar.innerHTML = originalContent;
                
                // Reattach event listener to create group button
                document.getElementById('create-group-button').addEventListener('click', showCreateGroupView);
                
                // Load the groups
                loadGroups();
            });
            
            // Handle form submission to proceed to add members
            document.getElementById('create-group-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const groupName = document.getElementById('group-name').value.trim();
                const groupDescription = document.getElementById('group-description').value.trim();
                
                if (!groupName) {
                    showNotification('Group name is required', 'error');
                    return;
                }
                
                // Show member selection view
                showGroupMemberSelection(groupName, groupDescription);
            });
        }
        
        // Function to show member selection for new group
        function showGroupMemberSelection(groupName, groupDescription) {
            // Get the sidebar
            const sidebar = document.querySelector('.sidebar');
            
            // Create member selection view
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-group-info" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Add Group Members</div>
                    </div>
                </div>
                
                <div style="padding: 15px; background-color: #111b21;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #e9edef; margin-bottom: 5px;">Group Info</label>
                        <div style="background-color: #2a3942; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="color: #e9edef; font-weight: bold;">${groupName}</div>
                            ${groupDescription ? `<div style="color: #8696a0; font-size: 14px; margin-top: 5px;">${groupDescription}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="search-container" style="margin-bottom: 15px;">
                        <div class="search-bar">
                            <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                                <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                            </svg>
                            <input type="text" id="member-search-input" placeholder="Search contacts" onkeyup="searchMemberContacts()">
                        </div>
                    </div>
                    
                    <div id="member-selection-list" class="contact-list" style="max-height: 300px; overflow-y: auto;">
                        <div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">
                            Loading contacts...
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button id="create-group-submit" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            Create Group
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listener to back button
            document.getElementById('back-to-group-info').addEventListener('click', function() {
                // Go back to the create group form
                showCreateGroupView();
                
                // Fill in the form with the previous values
                setTimeout(() => {
                    document.getElementById('group-name').value = groupName;
                    document.getElementById('group-description').value = groupDescription;
                }, 100);
            });
            
            // Load contacts for selection
            loadContactsForSelection();
            
            // Add event listener to create group button
            document.getElementById('create-group-submit').addEventListener('click', function() {
                const selectedMembers = document.querySelectorAll('.member-checkbox:checked');
                const memberIds = Array.from(selectedMembers).map(checkbox => checkbox.value);
                
                if (memberIds.length === 0) {
                    showNotification('Please select at least one member for the group', 'warning');
                    return;
                }
                
                // Create the group with selected members
                createGroup(groupName, groupDescription, memberIds);
            });
        }
        
        // Function to load contacts for member selection
        function loadContactsForSelection() {
            const memberList = document.getElementById('member-selection-list');
            
            fetch('/chat/contacts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    return response.json();
                })
                .then(contacts => {
                    if (contacts.length === 0) {
                        memberList.innerHTML = '<div style="color: #8696a0; text-align: center; padding: 20px;">No contacts found. Add contacts first.</div>';
                        return;
                    }
                    
                    return fetch('/chat/user_info')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load user info');
                            }
                            return response.json();
                        })
                        .then(users => {
                            // Create a map of user IDs to user details
                            const userMap = {};
                            users.forEach(user => {
                                userMap[user.id] = user;
                            });
                            
                            memberList.innerHTML = '';
                            
                            // Create contact elements for selection
                            contacts.forEach((contact) => {
                                const contactId = contact[0];
                                const displayName = contact[1] || (userMap[contactId] ? userMap[contactId].username : 'Unknown User');
                                
                                // Get user profile picture if available
                                const profilePic = userMap[contactId] && userMap[contactId].profile_picture 
                                    ? `/uploads/profile_photos/${userMap[contactId].profile_picture}` 
                                    : '/api/placeholder/49/49';
                                
                                const contactElement = document.createElement('div');
                                contactElement.className = 'contact';
                                contactElement.style.display = 'flex';
                                contactElement.style.alignItems = 'center';
                                
                                contactElement.innerHTML = `
                                    <div style="margin-right: 15px;">
                                        <input type="checkbox" class="member-checkbox" value="${contactId}" id="member-${contactId}" style="width: 18px; height: 18px; cursor: pointer;">
                                    </div>
                                    <label for="member-${contactId}" style="display: flex; flex: 1; cursor: pointer;">
                                        <div class="profile-pic" style="margin-right: 15px;">
                                            <img src="${profilePic}" alt="${displayName}">
                                        </div>
                                        <div class="contact-info">
                                            <div class="contact-name">${displayName}</div>
                                        </div>
                                    </label>
                                `;
                                
                                memberList.appendChild(contactElement);
                            });
                        });
                })
                .catch(error => {
                    console.error('Error loading contacts for selection:', error);
                    memberList.innerHTML = '<div style="color: #ff6b6b; text-align: center; padding: 20px;">Error loading contacts</div>';
                });
        }
        
        // Function to search member contacts
        function searchMemberContacts() {
            const searchInput = document.getElementById('member-search-input');
            const filter = searchInput.value.toLowerCase();
            const contacts = document.getElementById('member-selection-list').querySelectorAll('.contact');
            
            contacts.forEach(contact => {
                const name = contact.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    contact.style.display = 'flex';
                } else {
                    contact.style.display = 'none';
                }
            });
        }
        
        // Function to create a group
        function createGroup(groupName, groupDescription, memberIds) {
            const data = {
                group_name: groupName,
                description: groupDescription,
                member_ids: memberIds
            };
            
            fetch('/chat/create_group', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to create group');
                }
                return response.json();
            })
            .then(data => {
                showNotification('Group created successfully', 'success');
                
                // Show groups view
                showGroupsView();
                
                // Load the new group chat
                setTimeout(() => {
                    loadGroupChat(data.group_id);
                }, 500);
            })
            .catch(error => {
                console.error('Error creating group:', error);
                showNotification('Failed to create group: ' + error.message, 'error');
            });
        }

        // Function to show user info
        function showUserInfo(user) {
            // Create a modal to display user info
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'flex-end'; // Align to right side
            modal.style.alignItems = 'stretch';
            
            // User profile picture
            const profilePic = user.profile_picture ? `/uploads/profile_photos/${user.profile_picture}` : '/api/placeholder/80/80';
            
            // Create side panel
            const panel = document.createElement('div');
            panel.className = 'user-info-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '350px';
            panel.style.maxWidth = '100%';
            panel.style.height = '100%';
            panel.style.overflowY = 'auto';
            panel.style.transition = 'transform 0.3s ease';
            panel.style.boxShadow = '-5px 0 15px rgba(0, 0, 0, 0.1)';
            
            panel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                    <div id="close-user-info" style="cursor: pointer; margin-right: 15px;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19.8 11H7.5l5.6-5.6L11.7 4l-8 8 8 8 1.4-1.4L7.5 13h12.3v-2z"></path>
                        </svg>
                    </div>
                    <h2 style="color: #e9edef; margin: 0;">Contact Info</h2>
                </div>
                
                <div style="padding: 20px; text-align: center; border-bottom: 1px solid #2a3942;">
                    <div style="width: 150px; height: 150px; border-radius: 75px; overflow: hidden; margin: 0 auto 15px;">
                        <img src="${profilePic}" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h2 style="color: #e9edef; margin-bottom: 5px;">${user.name || user.username}</h2>
                    <p style="color: #8696a0; margin-bottom: 0;">@${user.username}</p>
                </div>
                
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: #e9edef; margin-bottom: 10px; font-size: 16px;">About</h3>
                    <p style="color: #e9edef; margin: 0;">${user.bio || 'No information provided'}</p>
                </div>
                
                <div style="padding: 15px;">
                    <div style="margin-top: 20px;">
                        <button id="block-user-btn" class="action-button" style="width: 100%; padding: 12px; background-color: #1f2c33; color: #f15c6d; border: 1px solid #2a3942; border-radius: 5px; margin-bottom: 10px; cursor: pointer; font-size: 16px;">
                            Block Contact
                        </button>
                        <button id="remove-user-btn" class="action-button" style="width: 100%; padding: 12px; background-color: #1f2c33; color: #f15c6d; border: 1px solid #2a3942; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            Remove Contact
                        </button>
                    </div>
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add a slight delay for animation effect
            setTimeout(() => {
                panel.style.transform = 'translateX(0)';
            }, 10);
            
            // Close panel when button is clicked
            document.getElementById('close-user-info').addEventListener('click', function() {
                panel.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            });
            
            // Close panel when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    panel.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(modal);
                    }, 300);
                }
            });
            
            // Handle block user action
            document.getElementById('block-user-btn').addEventListener('click', function() {
                // You would implement the actual blocking functionality here
                showNotification('This feature is not yet implemented', 'warning');
            });
            
            // Handle remove contact action
            document.getElementById('remove-user-btn').addEventListener('click', function() {
                // You would implement the actual contact removal here
                showNotification('This feature is not yet implemented', 'warning');
            });
        }

        // Function to show settings sidebar
        function showSettingsSidebar() {
            // Hide the main sidebar
            document.querySelector('.sidebar').style.display = 'none';
            
            // Show the settings sidebar
            const settingsSidebar = document.querySelector('.settings-sidebar');
            settingsSidebar.style.display = 'flex';
            
            // Add event listener to back button
            document.querySelector('.sidebar-header-back').addEventListener('click', function() {
                // Hide settings sidebar
                settingsSidebar.style.display = 'none';
                
                // Show main sidebar
                document.querySelector('.sidebar').style.display = 'flex';
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            });
            
            // Add event listener to close button to return to contact list
            document.querySelector('.close-settings').addEventListener('click', function() {
                // Hide settings sidebar
                settingsSidebar.style.display = 'none';
                
                // Show main sidebar
                document.querySelector('.sidebar').style.display = 'flex';
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            });
            
            // Add event listeners to settings options
            document.querySelectorAll('.settings-option').forEach((option, index) => {
                option.addEventListener('click', function() {
                    // Handle different settings options
                    if (index === 0) {
                        // Change Language
                        showLanguageSettings();
                    } else if (index === 1) {
                        // Change Password
                        showPasswordSettings();
                    } else if (index === 2) {
                        // Admin Panel
                        showAdminPanel();
                    }
                });
            });
        }
        
        // Function to show language settings
        function showLanguageSettings() {
            // Create a modal to display language settings
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            // Create the language settings panel
            const panel = document.createElement('div');
            panel.className = 'language-settings-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';
            panel.style.borderRadius = '10px';
            panel.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
            
            panel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h2 style="color: #e9edef; margin: 0; flex: 1;">Change Language</h2>
                    <div style="display: flex;">
                        <div id="return-to-contacts" style="cursor: pointer; margin-right: 15px;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5c-3.58 0-6.5-2.92-6.5-6.5S8.42 5.5 12 5.5s6.5 2.92 6.5 6.5-2.92 6.5-6.5 6.5zm0-12c-3.03 0-5.5 2.47-5.5 5.5s2.47 5.5 5.5 5.5 5.5-2.47 5.5-5.5-2.47-5.5-5.5-5.5z"></path>
                                <path fill="currentColor" d="M12 18.5c3.03 0 5.5-2.47 5.5-5.5S15.03 7.5 12 7.5 6.5 9.97 6.5 13s2.47 5.5 5.5 5.5zm0-10c2.48 0 4.5 2.02 4.5 4.5S14.48 17.5 12 17.5 7.5 15.48 7.5 13 9.52 8.5 12 8.5z"></path>
                            </svg>
                        </div>
                        <div id="close-language-settings" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px;">
                    <div class="language-option" style="padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; background-color: #00a884; color: white;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>English</span>
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <div class="language-option" style="padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; background-color: #202c33; color: #e9edef;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>Русский</span>
                        </div>
                    </div>
                    
                    <div class="language-option" style="padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; background-color: #202c33; color: #e9edef;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>Кыргызча</span>
                        </div>
                    </div>
                    
                    <div class="language-option" style="padding: 12px; border-radius: 8px; cursor: pointer; background-color: #202c33; color: #e9edef;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>العربية</span>
                        </div>
                    </div>
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add event listener to close button
            document.getElementById('close-language-settings').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // Add event listener to return to contacts button
            document.getElementById('return-to-contacts').addEventListener('click', function() {
                document.body.removeChild(modal);
                
                // Hide settings sidebar
                document.querySelector('.settings-sidebar').style.display = 'none';
                
                // Show main sidebar
                document.querySelector('.sidebar').style.display = 'flex';
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            });
            
            // Add event listeners to language options
            const languageOptions = panel.querySelectorAll('.language-option');
            languageOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    languageOptions.forEach(opt => {
                        opt.style.backgroundColor = '#202c33';
                        opt.style.color = '#e9edef';
                        
                        // Remove check icon if it exists
                        const checkIcon = opt.querySelector('svg');
                        if (checkIcon) {
                            checkIcon.remove();
                        }
                    });
                    
                    // Add active class to clicked option
                    this.style.backgroundColor = '#00a884';
                    this.style.color = 'white';
                    
                    // Add check icon if it doesn't exist
                    if (!this.querySelector('svg')) {
                        const checkIcon = document.createElement('div');
                        checkIcon.innerHTML = `
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"></path>
                            </svg>
                        `;
                        this.querySelector('div').appendChild(checkIcon.firstElementChild);
                    }
                    
                    // Show a notification
                    showNotification('Language changed successfully', 'success');
                    
                    // Close the modal after a short delay
                    setTimeout(() => {
                        document.body.removeChild(modal);
                    }, 1000);
                });
            });
            
            // Close when clicked outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // Function to show password settings
        function showPasswordSettings() {
            // Create a modal to display password settings
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            // Create the password settings panel
            const panel = document.createElement('div');
            panel.className = 'password-settings-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';
            panel.style.borderRadius = '10px';
            panel.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
            
            panel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h2 style="color: #e9edef; margin: 0; flex: 1;">Change Password</h2>
                    <div style="display: flex;">
                        <div id="return-to-contacts-from-password" style="cursor: pointer; margin-right: 15px;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5c-3.58 0-6.5-2.92-6.5-6.5S8.42 5.5 12 5.5s6.5 2.92 6.5 6.5-2.92 6.5-6.5 6.5zm0-12c-3.03 0-5.5 2.47-5.5 5.5s2.47 5.5 5.5 5.5 5.5-2.47 5.5-5.5-2.47-5.5-5.5-5.5z"></path>
                                <path fill="currentColor" d="M12 18.5c3.03 0 5.5-2.47 5.5-5.5S15.03 7.5 12 7.5 6.5 9.97 6.5 13s2.47 5.5 5.5 5.5zm0-10c2.48 0 4.5 2.02 4.5 4.5S14.48 17.5 12 17.5 7.5 15.48 7.5 13 9.52 8.5 12 8.5z"></path>
                            </svg>
                        </div>
                        <div id="close-password-settings" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px;">
                    <form id="password-form">
                        <div style="margin-bottom: 15px;">
                            <label for="current-password" style="display: block; color: #e9edef; margin-bottom: 5px;">Current Password</label>
                            <input type="password" id="current-password" style="width: 100%; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px;" placeholder="Enter current password">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label for="new-password" style="display: block; color: #e9edef; margin-bottom: 5px;">New Password</label>
                            <input type="password" id="new-password" style="width: 100%; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px;" placeholder="Enter new password">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="confirm-password" style="display: block; color: #e9edef; margin-bottom: 5px;">Confirm New Password</label>
                            <input type="password" id="confirm-password" style="width: 100%; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px;" placeholder="Confirm new password">
                        </div>
                        
                        <button type="submit" style="width: 100%; padding: 12px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Change Password</button>
                    </form>
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add event listener to close button
            document.getElementById('close-password-settings').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // Add event listener to password form
            document.getElementById('password-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showNotification('Please fill all fields', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showNotification('New passwords do not match', 'error');
                    return;
                }
                
                // Call the change password API
                fetch('/api/change_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: document.querySelector('.chat-header-name').textContent,
                        old_password: currentPassword,
                        new_password: newPassword
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "Password changed successfully!") {
                        showNotification('Password changed successfully', 'success');
                        document.body.removeChild(modal);
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error changing password:', error);
                    showNotification('Failed to change password. Please try again.', 'error');
                });
            });
            
            // Close when clicked outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // Add event listener to return to contacts button
            document.getElementById('return-to-contacts-from-password').addEventListener('click', function() {
                document.body.removeChild(modal);
                
                // Hide settings sidebar
                document.querySelector('.settings-sidebar').style.display = 'none';
                
                // Show main sidebar
                document.querySelector('.sidebar').style.display = 'flex';
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            });
        }
        
        // Function to show admin panel
        function showAdminPanel() {
            // Create a modal for admin authentication
            const authModal = document.createElement('div');
            authModal.className = 'modal';
            authModal.style.position = 'fixed';
            authModal.style.top = '0';
            authModal.style.left = '0';
            authModal.style.width = '100%';
            authModal.style.height = '100%';
            authModal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            authModal.style.zIndex = '1000';
            authModal.style.display = 'flex';
            authModal.style.justifyContent = 'center';
            authModal.style.alignItems = 'center';
            
            // Create authentication panel
            const authPanel = document.createElement('div');
            authPanel.className = 'auth-panel';
            authPanel.style.backgroundColor = '#1f2c33';
            authPanel.style.width = '400px';
            authPanel.style.maxWidth = '90%';
            authPanel.style.borderRadius = '10px';
            authPanel.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
            
            authPanel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h2 style="color: #e9edef; margin: 0; flex: 1;">Admin Authentication</h2>
                    <div style="display: flex;">
                        <div id="return-to-contacts-from-auth" style="cursor: pointer; margin-right: 15px;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5c-3.58 0-6.5-2.92-6.5-6.5S8.42 5.5 12 5.5s6.5 2.92 6.5 6.5-2.92 6.5-6.5 6.5zm0-12c-3.03 0-5.5 2.47-5.5 5.5s2.47 5.5 5.5 5.5 5.5-2.47 5.5-5.5-2.47-5.5-5.5-5.5z"></path>
                                <path fill="currentColor" d="M12 18.5c3.03 0 5.5-2.47 5.5-5.5S15.03 7.5 12 7.5 6.5 9.97 6.5 13s2.47 5.5 5.5 5.5zm0-10c2.48 0 4.5 2.02 4.5 4.5S14.48 17.5 12 17.5 7.5 15.48 7.5 13 9.52 8.5 12 8.5z"></path>
                            </svg>
                        </div>
                        <div id="close-auth-panel" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e9edef; margin-bottom: 10px;">User Management</h3>
                        <button id="load-users-btn" style="padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Load All Users</button>
                        <div id="users-container" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; color: #8696a0; padding: 20px;">
                                Click "Load All Users" to view all registered users
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e9edef; margin-bottom: 10px;">System Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00a884; font-size: 24px; font-weight: bold;">12</div>
                                <div style="color: #e9edef;">Total Users</div>
                            </div>
                            
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00a884; font-size: 24px; font-weight: bold;">42</div>
                                <div style="color: #e9edef;">Messages Today</div>
                            </div>
                            
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00a884; font-size: 24px; font-weight: bold;">3</div>
                                <div style="color: #e9edef;">Groups Created</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            authModal.appendChild(authPanel);
            document.body.appendChild(authModal);
            
            // Add event listener to close button
            document.getElementById('close-auth-panel').addEventListener('click', function() {
                document.body.removeChild(authModal);
            });
            
            // Add event listener to return to contacts button
            document.getElementById('return-to-contacts-from-auth').addEventListener('click', function() {
                document.body.removeChild(authModal);
                
                // Hide settings sidebar
                document.querySelector('.settings-sidebar').style.display = 'none';
                
                // Show main sidebar
                document.querySelector('.sidebar').style.display = 'flex';
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            });
            
            // Add event listener to load users button
            document.getElementById('load-users-btn').addEventListener('click', function() {
                const usersContainer = document.getElementById('users-container');
                usersContainer.innerHTML = '<div style="text-align: center; color: #e9edef; padding: 20px;">Loading users...</div>';
                
                // Fetch all users
                fetch('/api/users')
                    .then(response => response.json())
                    .then(data => {
                        if (data.users && data.users.length > 0) {
                            usersContainer.innerHTML = `
                                <table style="width: 100%; border-collapse: collapse; color: #e9edef;">
                                    <thead>
                                        <tr>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">ID</th>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">Username</th>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">Email</th>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.users.map(user => `
                                            <tr>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">${user.id}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">${user.username}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">${user.email || 'N/A'}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">
                                                    <button class="edit-user-btn" data-user-id="${user.id}" style="background-color: #00a884; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer; margin-right: 5px;">Edit</button>
                                                    <button class="delete-user-btn" data-user-id="${user.id}" style="background-color: #f15c6d; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer;">Delete</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                            
                            // Add event listeners to action buttons
                            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const userId = this.getAttribute('data-user-id');
                                    showNotification(`Edit user functionality for user ${userId} is not implemented yet`, 'warning');
                                });
                            });
                            
                            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const userId = this.getAttribute('data-user-id');
                                    if (confirm(`Are you sure you want to delete user with ID ${userId}?`)) {
                                        showNotification(`Delete user functionality for user ${userId} is not implemented yet`, 'warning');
                                    }
                                });
                            });
                        } else {
                            usersContainer.innerHTML = '<div style="text-align: center; color: #e9edef; padding: 20px;">No users found</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading users:', error);
                        usersContainer.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Error loading users</div>';
                    });
            });
            
            // Close when clicked outside
            authModal.addEventListener('click', function(e) {
                if (e.target === authModal) {
                    document.body.removeChild(authModal);
                }
            });
        }

        // Function to show actual admin panel
        function showActualAdminPanel() {
            // Create a modal to display admin panel
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            // Create the admin panel
            const panel = document.createElement('div');
            panel.className = 'admin-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '800px';
            panel.style.maxWidth = '90%';
            panel.style.maxHeight = '80%';
            panel.style.overflowY = 'auto';
            panel.style.borderRadius = '10px';
            panel.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
            
            panel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942; position: sticky; top: 0; background-color: #1f2c33; z-index: 1;">
                    <h2 style="color: #e9edef; margin: 0; flex: 1;">Admin Panel</h2>
                    <div style="display: flex;">
                        <div id="return-to-contacts-from-admin" style="cursor: pointer; margin-right: 15px;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5c-3.58 0-6.5-2.92-6.5-6.5S8.42 5.5 12 5.5s6.5 2.92 6.5 6.5-2.92 6.5-6.5 6.5zm0-12c-3.03 0-5.5 2.47-5.5 5.5s2.47 5.5 5.5 5.5 5.5-2.47 5.5-5.5-2.47-5.5-5.5-5.5z"></path>
                                <path fill="currentColor" d="M12 18.5c3.03 0 5.5-2.47 5.5-5.5S15.03 7.5 12 7.5 6.5 9.97 6.5 13s2.47 5.5 5.5 5.5zm0-10c2.48 0 4.5 2.02 4.5 4.5S14.48 17.5 12 17.5 7.5 15.48 7.5 13 9.52 8.5 12 8.5z"></path>
                            </svg>
                        </div>
                        <div id="close-admin-panel" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e9edef; margin-bottom: 10px;">User Management</h3>
                        <button id="load-users-btn" style="padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Load All Users</button>
                        <div id="users-container" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; color: #8696a0; padding: 20px;">
                                Click "Load All Users" to view all registered users
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e9edef; margin-bottom: 10px;">System Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00a884; font-size: 24px; font-weight: bold;">12</div>
                                <div style="color: #e9edef;">Total Users</div>
                            </div>
                            
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00a884; font-size: 24px; font-weight: bold;">42</div>
                                <div style="color: #e9edef;">Messages Today</div>
                            </div>
                            
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00a884; font-size: 24px; font-weight: bold;">3</div>
                                <div style="color: #e9edef;">Groups Created</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add event listener to close button
            document.getElementById('close-admin-panel').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // Add event listener to return to contacts button
            document.getElementById('return-to-contacts-from-admin').addEventListener('click', function() {
                document.body.removeChild(modal);
                
                // Hide settings sidebar
                document.querySelector('.settings-sidebar').style.display = 'none';
                
                // Show main sidebar
                document.querySelector('.sidebar').style.display = 'flex';
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            });
            
            // Add event listener to load users button
            document.getElementById('load-users-btn').addEventListener('click', function() {
                const usersContainer = document.getElementById('users-container');
                usersContainer.innerHTML = '<div style="text-align: center; color: #e9edef; padding: 20px;">Loading users...</div>';
                
                // Fetch all users
                fetch('/api/users')
                    .then(response => response.json())
                    .then(data => {
                        if (data.users && data.users.length > 0) {
                            usersContainer.innerHTML = `
                                <table style="width: 100%; border-collapse: collapse; color: #e9edef;">
                                    <thead>
                                        <tr>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">ID</th>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">Username</th>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">Email</th>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.users.map(user => `
                                            <tr>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">${user.id}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">${user.username}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">${user.email || 'N/A'}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">
                                                    <button class="edit-user-btn" data-user-id="${user.id}" style="background-color: #00a884; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer; margin-right: 5px;">Edit</button>
                                                    <button class="delete-user-btn" data-user-id="${user.id}" style="background-color: #f15c6d; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer;">Delete</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                            
                            // Add event listeners to action buttons
                            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const userId = this.getAttribute('data-user-id');
                                    showNotification(`Edit user functionality for user ${userId} is not implemented yet`, 'warning');
                                });
                            });
                            
                            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const userId = this.getAttribute('data-user-id');
                                    if (confirm(`Are you sure you want to delete user with ID ${userId}?`)) {
                                        showNotification(`Delete user functionality for user ${userId} is not implemented yet`, 'warning');
                                    }
                                });
                            });
                        } else {
                            usersContainer.innerHTML = '<div style="text-align: center; color: #e9edef; padding: 20px;">No users found</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading users:', error);
                        usersContainer.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Error loading users</div>';
                    });
            });
            
            // Close when clicked outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // Function to view user details
        function viewUserDetails(userId) {
            // In a real application, you would fetch detailed user information from the server
            // For demonstration purposes, we'll show a simple modal with mock data
            
            // Create a modal to display user details
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1100'; // Higher than the admin panel
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            // Create the user details panel
            const panel = document.createElement('div');
            panel.className = 'user-details-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '500px';
            panel.style.maxWidth = '90%';
            panel.style.borderRadius = '10px';
            panel.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
            
            panel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h2 style="color: #e9edef; margin: 0; flex: 1;">User Details</h2>
                    <div style="display: flex;">
                        <div id="return-to-contacts-from-user-details" style="cursor: pointer; margin-right: 15px;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5c-3.58 0-6.5-2.92-6.5-6.5S8.42 5.5 12 5.5s6.5 2.92 6.5 6.5-2.92 6.5-6.5 6.5zm0-12c-3.03 0-5.5 2.47-5.5 5.5s2.47 5.5 5.5 5.5 5.5-2.47 5.5-5.5-2.47-5.5-5.5-5.5z"></path>
                                <path fill="currentColor" d="M12 18.5c3.03 0 5.5-2.47 5.5-5.5S15.03 7.5 12 7.5 6.5 9.97 6.5 13s2.47 5.5 5.5 5.5zm0-10c2.48 0 4.5 2.02 4.5 4.5S14.48 17.5 12 17.5 7.5 15.48 7.5 13 9.52 8.5 12 8.5z"></path>
                            </svg>
                        </div>
                        <div id="close-user-details" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px; text-align: center; border-bottom: 1px solid #2a3942;">
                    <div style="width: 150px; height: 150px; border-radius: 75px; overflow: hidden; margin: 0 auto 15px;">
                        <img src="/api/placeholder/150/150" alt="User Profile" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h2 style="color: #e9edef; margin-bottom: 5px;">User Name</h2>
                    <p style="color: #8696a0; margin-bottom: 0;">@username</p>
                </div>
                
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: #e9edef; margin-bottom: 10px; font-size: 16px;">About</h3>
                    <p style="color: #e9edef; margin: 0;">This is a brief description of the user's profile.</p>
                </div>
                
                <div style="padding: 15px;">
                    <div style="margin-top: 20px;">
                        <button id="block-user-btn" class="action-button" style="width: 100%; padding: 12px; background-color: #1f2c33; color: #f15c6d; border: 1px solid #2a3942; border-radius: 5px; margin-bottom: 10px; cursor: pointer; font-size: 16px;">
                            Block Contact
                        </button>
                        <button id="remove-user-btn" class="action-button" style="width: 100%; padding: 12px; background-color: #1f2c33; color: #f15c6d; border: 1px solid #2a3942; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            Remove Contact
                        </button>
                    </div>
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add a slight delay for animation effect
            setTimeout(() => {
                panel.style.transform = 'translateX(0)';
            }, 10);
            
            // Close panel when button is clicked
            document.getElementById('close-user-details').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // Add event listener to return to contacts button
            document.getElementById('return-to-contacts-from-user-details').addEventListener('click', function() {
                document.body.removeChild(modal);
                
                // Hide any other open panels
                const adminPanel = document.querySelector('.admin-panel');
                if (adminPanel && adminPanel.parentElement) {
                    adminPanel.parentElement.remove();
                }
                
                // Hide settings sidebar
                document.querySelector('.settings-sidebar').style.display = 'none';
                
                // Show main sidebar
                document.querySelector('.sidebar').style.display = 'flex';
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            });
        }
    </script>
</body>
</html>